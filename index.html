<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Lenticular Text For Emacs</title>
<!-- 2016-07-25 Mon 08:56 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="Phillip Lord" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="lenticular.css" />

<script type="text/javascript" src="http://orgmode.org/org-info.js">
/**
 *
 * @source: http://orgmode.org/org-info.js
 *
 * @licstart  The following is the entire license notice for the
 *  JavaScript code in http://orgmode.org/org-info.js.
 *
 * Copyright (C) 2012-2013 Free Software Foundation, Inc.
 *
 *
 * The JavaScript code in this tag is free software: you can
 * redistribute it and/or modify it under the terms of the GNU
 * General Public License (GNU GPL) as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option)
 * any later version.  The code is distributed WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.
 *
 * As additional permission under GNU GPL version 3 section 7, you
 * may distribute non-source (e.g., minimized or compacted) forms of
 * that code without the copy of the GNU GPL normally required by
 * section 4, provided you include this license notice and a URL
 * through which recipients can access the Corresponding Source.
 *
 * @licend  The above is the entire license notice
 * for the JavaScript code in http://orgmode.org/org-info.js.
 *
 */
</script>

<script type="text/javascript">

/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/

<!--/*--><![CDATA[/*><!--*/
org_html_manager.set("TOC_DEPTH", "3");
org_html_manager.set("LINK_HOME", "");
org_html_manager.set("LINK_UP", "");
org_html_manager.set("LOCAL_TOC", "1");
org_html_manager.set("VIEW_BUTTONS", "0");
org_html_manager.set("MOUSE_HINT", "underline");
org_html_manager.set("FIXED_TOC", "0");
org_html_manager.set("TOC", "0");
org_html_manager.set("VIEW", "info");
org_html_manager.setup();  // activate after the parameters are set
/*]]>*///-->
</script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Lenticular Text For Emacs</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Introduction</a>
<ul>
<li><a href="#sec-1-1">1.1. Caveat</a></li>
</ul>
</li>
<li><a href="#sec-2">2. Getting Started</a>
<ul>
<li><a href="#sec-2-1">2.1. Installing</a></li>
<li><a href="#sec-2-2">2.2. With existing lentic source</a></li>
<li><a href="#sec-2-3">2.3. Converting legacy source</a></li>
</ul>
</li>
<li><a href="#sec-3">3. Lentic</a>
<ul>
<li><a href="#sec-3-1">3.1. Commentary</a></li>
<li><a href="#sec-3-2">3.2. Usage</a></li>
<li><a href="#sec-3-3">3.3. Configuration</a></li>
<li><a href="#sec-3-4">3.4. Status</a></li>
<li><a href="#sec-3-5">3.5. Code</a>
<ul>
<li><a href="#sec-3-5-1">3.5.1. State</a></li>
<li><a href="#sec-3-5-2">3.5.2. Base Configuration</a></li>
<li><a href="#sec-3-5-3">3.5.3. Default Configuration</a></li>
<li><a href="#sec-3-5-4">3.5.4. Basic Operation</a></li>
<li><a href="#sec-3-5-5">3.5.5. Batch Functions</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-4">4. Lentic Mode</a>
<ul>
<li><a href="#sec-4-1">4.1. Commentary</a></li>
<li><a href="#sec-4-2">4.2. Code</a>
<ul>
<li><a href="#sec-4-2-1">4.2.1. Preliminaries</a></li>
<li><a href="#sec-4-2-2">4.2.2. Utility</a></li>
<li><a href="#sec-4-2-3">4.2.3. Window and Buffer Functions</a></li>
<li><a href="#sec-4-2-4">4.2.4. Minor Mode</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-5">5. Lentic Rot13</a>
<ul>
<li><a href="#sec-5-1">5.1. Commentary</a></li>
<li><a href="#sec-5-2">5.2. Code</a></li>
</ul>
</li>
<li><a href="#sec-6">6. Lentic Chunk</a>
<ul>
<li><a href="#sec-6-1">6.1. Commentary</a></li>
<li><a href="#sec-6-2">6.2. Code</a>
<ul>
<li><a href="#sec-6-2-1">6.2.1. Chunk Configuration</a></li>
<li><a href="#sec-6-2-2">6.2.2. Unmatched Chunk Configuration</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-7">7. Lentic Asciidoc</a>
<ul>
<li><a href="#sec-7-1">7.1. Commentary</a></li>
<li><a href="#sec-7-2">7.2. Code</a></li>
</ul>
</li>
<li><a href="#sec-8">8. Lentic Latex</a>
<ul>
<li><a href="#sec-8-1">8.1. Commentary</a></li>
<li><a href="#sec-8-2">8.2. Code</a></li>
</ul>
</li>
<li><a href="#sec-9">9. Lentic Org</a>
<ul>
<li><a href="#sec-9-1">9.1. Commentary</a></li>
<li><a href="#sec-9-2">9.2. Code</a>
<ul>
<li><a href="#sec-9-2-1">9.2.1. Simple org-&gt;el</a></li>
<li><a href="#sec-9-2-2">9.2.2. orgel-&gt;org</a></li>
<li><a href="#sec-9-2-3">9.2.3. org-&gt;clojure</a></li>
<li><a href="#sec-9-2-4">9.2.4. org-&gt;python</a></li>
</ul>
</li>
<li><a href="#sec-9-3">9.3. Footer</a></li>
</ul>
</li>
<li><a href="#sec-10">10. Lentic Dev</a>
<ul>
<li><a href="#sec-10-1">10.1. Commentary</a></li>
<li><a href="#sec-10-2">10.2. Code</a>
<ul>
<li><a href="#sec-10-2-1">10.2.1. Manual Updates</a></li>
<li><a href="#sec-10-2-2">10.2.2. Font-Lock changes</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-11">11. Lentic Doc</a>
<ul>
<li><a href="#sec-11-1">11.1. Commentary</a></li>
<li><a href="#sec-11-2">11.2. Code</a>
<ul>
<li><a href="#sec-11-2-1">11.2.1. Orgify Package</a></li>
<li><a href="#sec-11-2-2">11.2.2. htmlify package</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
<p>
This package implements lenticular text: simultaneous editing and viewing of
the same (or closely related) text in two or more buffers. While lentic has
many potential uses it also enables a form of literate programming. This is
the literate documentation for lentic.
</p>

<p>
Documentation for each package is organised according to approximate usage in
documentation terms. So the core package (lentic) comes first, then that
associated with the mode, and then a package which is useless but good for
understanding how to configure lentic for new environments.
</p>
</div>

<div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> Caveat</h3>
<div class="outline-text-3" id="text-1-1">
<p>
The general idea of using lentic to document itself is a good one; I think the
general principle of dogfooding making sense. It has a disadvantage, though.
At the moment, lentic is not finished, nor is the transformation that I am
using to generate the documentation. So, the output is currently not ideal;
this makes it both harder to read than ideal, nor the best advert for lentic.
</p>

<p>
It will improve!
</p>
</div>
</div>
</div>


<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Getting Started</h2>
<div class="outline-text-2" id="text-2">
<p>
In this section, I describe how to use one particular use of lentic &#x2013;
translating between Emacs-Lisp and Org-mode. This is not the only use of
lentic as it neither specific to Emacs-Lisp nor Org-mode, but it's an easy one
to get started with.
</p>
</div>

<div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1"><span class="section-number-3">2.1</span> Installing</h3>
<div class="outline-text-3" id="text-2-1">
<p>
Lentic can be installed using MELPA or Marmalade. Personally, I like MELPA
stable, so add the following to your <code>.emacs</code> file.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(add-to-list 'package-archives
             '(<span style="color: #ffa07a;">"melpa-stable"</span> . <span style="color: #ffa07a;">"http://stable.melpa.org/packages/"</span>) t)
</pre>
</div>

<p>
Now install "lentic" and then type <code>M-x global-lentic-mode</code>.
</p>
</div>
</div>


<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2"><span class="section-number-3">2.2</span> With existing lentic source</h3>
<div class="outline-text-3" id="text-2-2">
<p>
The easiest way to use lentic is with source which is already formatted
appropriately for lentic, including the source code for lentic. 
</p>

<p>
First, clone the lentic repository. This contains a <code>.dir-locals.el</code> file, in
addition to the source, which tells lentic how to create a lentic-buffer.
</p>

<pre class="example">
git clone https://github.com/phillord/lentic.git
</pre>

<p>
Now, open lentic.el in Emacs. You should get prompted to accept a unsafe
directory local variable. If you trust me, then type "y" or "!".
</p>

<p>
To create the lentic buffer, press <code>C-c,c</code> or "Edit-&gt;Lentic-&gt;Create All",
followed by <code>C-c,b</code> or "Edit-&gt;Lentic-&gt;Split Below" to show both Emacs-Lisp and
Org-mode file at the same time.
</p>
</div>
</div>


<div id="outline-container-sec-2-3" class="outline-3">
<h3 id="sec-2-3"><span class="section-number-3">2.3</span> Converting legacy source</h3>
<div class="outline-text-3" id="text-2-3">
<p>
To convert some an existing source file called, say, blah.el into a lentic
file.
</p>

<ul class="org-ul">
<li>Add <code>;; #+BEGIN_SRC emacs-lisp</code> after introductory comments but before any
source.
</li>
<li>Add <code>;; #+END_SRC</code> as the last line.
</li>
<li>Before the file header (if you have one!), add <code>;;; Header:</code>
</li>
<li>Add a <code>.dir-local.el</code> as follows:
</li>
</ul>

<div class="org-src-container">

<pre class="src src-emacs-lisp">((emacs-lisp-mode
  (lentic-init . lentic-orgel-org-init)))
</pre>
</div>

<p>
You should now have something like this:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp"><span style="color: #ff7f24;">;;; </span><span style="color: #ff7f24;">blah.el --- stuff, stuff stuff</span>

<span style="color: #ff7f24;">;;; </span><span style="color: #ff7f24;">Header:</span>

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">This file is not part of Emacs</span>

<span style="color: #ff7f24;">;;; </span><span style="color: #ff7f24;">Code:</span>

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">#+BEGIN_SRC emacs-lisp</span>
(<span style="color: #00ffff;">provide</span> '<span style="color: #7fffd4;">blah</span>)
<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">#+END_SRC</span>
</pre>
</div>

<p>
Your buffer should now be set up for lentic. Either close and reopen or type
<code>M-x revert-buffer</code> to ensure `lentic-init' has been configured.
</p>

<p>
To add documentation, I make heavy use of `org-babel-demarcate-block' to split
the single large Emacs-Lisp code blocks into smaller blocks as I go. The whole
buffer remains properly formatted throughout this way.
</p>
</div>
</div>
</div>


<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Lentic</h2>
<div class="outline-text-2" id="text-3">
<p>
lentic.el is the central point of this package. It provides the base
configuration options, the hooks into emacs change notification and the
default transformation (which copies text exactly).
</p>
</div>

<div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> Commentary</h3>
<div class="outline-text-3" id="text-3-1">
<p>
`lentic' enables <i>lenticular text</i>: simultaneous editing and viewing of the
same (or closely related) text in two or more buffers, potentially in
different modes. Lenticular text is named after lenticular printing, which
produce images which change depending on the angle at which they are
viewed.
</p>

<p>
Sometimes, it would be nice to edit a file in two ways at once. For
instance, you might have a source file in a computational language with
richly marked documentation. As Emacs is a modal editor, it would be nice
to edit this file both in a mode for the computational language and for the
marked up documentation.
</p>

<p>
One solution to this is to use a single-mode which supports both types of
editing. The problem with this is that it is fundamentally difficult to
support two types of editing at the same time; more over, you need a new
mode for each combination. Another solution is to use one of the
multiple-mode tools which are available. The problem with this is that they
generally need some support from the modes in question. And, again, the
difficulty is supporting both forms of editing in the same environment. A
final problem is that it is not just the editing environment that needs to
be adapted; the programmatic environment needs to be untroubled by the
documentation, and the documentation environment untroubled by the program
code.
</p>

<p>
Lenticular text provides an alternative solution. Two lentic buffers, by
default, the share content but are otherwise independent. Therefore,
you can have two buffers open, each showing the content in different modes;
to switch modes, you simply switch buffers. The content, location of point,
and view are shared.
</p>

<p>
Moreover, lentic buffers can also perform a bi-directional transformation
between the two. If this is done, then the two can have different but
related text. This also solves the problem of integration with a
tool-chain; each lentic buffer can be associated with a different file and
a different syntax. For example, this file is, itself, lenticular text. It
can be viewed either as Emacs-Lisp or in Org-Mode. In Emacs-Lisp mode, this
text is commented out, in org-mode it is not.
</p>

<p>
In fact, although the default behaviour of lentic appears to keep the same
text in each buffer, even it uses this bi-directional transformation
capability; while the text is shared, the text properties are not. This is
a behaviour which differs between lentic buffers and indirect buffers. The
lentic buffers can therefore be in different modes without fighting each
other to set the text properties.
</p>

<p>
It is possible to configure the transformation for any two buffers in a
extensible way. Mostly I have concentrated on mode-specific operation,
but, for instance, I have also used this ability on a per-project basis
controlling, for instance, the location of the lentic-file.
</p>
</div>
</div>

<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2"><span class="section-number-3">3.2</span> Usage</h3>
<div class="outline-text-3" id="text-3-2">
<p>
lentic can be installed through MELPA/Marmalade then add
</p>

<p>
(global-lentic-mode)
</p>

<p>
to your .emacs.
</p>

<p>
The main user entry points are accessible through the lentic edit menu, or
through `global-lentic-mode' which adds keybindings to create and manipulate
new lentic buffers. See `lentic-mode' commentary for more information.
</p>

<p>
By default, the lentic buffer created contains exactly the same contents as
the original buffer, but is otherwise separate; it can have a different major
modes, different syntax highlighting, invisible regions and even different
narrowing. Saving one buffer will save the other; killing the lentic buffer
does not affect the original, but killing the original also kills the lentic.
</p>

<p>
While this is somewhat useful, more generally a buffer will be configured to
produce a particular transformation. This can control many features of the
lentic, including the file name, major mode and an arbitrary transformation
between the two. Configuration is considered next.
</p>
</div>
</div>

<div id="outline-container-sec-3-3" class="outline-3">
<h3 id="sec-3-3"><span class="section-number-3">3.3</span> Configuration</h3>
<div class="outline-text-3" id="text-3-3">
<p>
lentic buffers are configurable in a large number of ways. It is possible
to control the nature of the transformation, the default buffer name that a
lentic buffer takes, and the file location (or not) of the lentic buffer.
Lentic now supports any number of lentic buffers, in relatively arbitrary
geometries, although this requires additional support from the
configuration objects.
</p>

<p>
Configuration of a buffer happens in one of two places. First,
`lentic-init' is run when a lentic buffer is first created. This function
should return the configuration object, and is mostly designed for use as a
file-local or dir-local variable. This object is stored in the `lentic-config'
and all subsequent operation happens through this.
</p>

<p>
There are now a number of different configurations, which can be used for
general-purposes use as well as an extension points for subclass
configurations. The two most general configurations are:
</p>

<ul class="org-ul">
<li>default: this copies all text exactly, but does not transfer
text-properties (which is the behaviour of indirect buffers). It is
possible to configure the default file or mode on a per-object basis.
</li>
<li>chunk: this is designed for programmatic syntaxes where chunks of code are
demarcated by start and end tags, and everything else is commented by
line-start comments. Comments are added or removed between the two buffers.
</li>
</ul>

<p>
The second of these is extended in lentic-org.el to provide the
configuration for this file: there is a normal emacs-lisp file in one buffer
and an org-mode version in another. Other programmatic and documentation modes
are supported in other files.
</p>
</div>
</div>

<div id="outline-container-sec-3-4" class="outline-3">
<h3 id="sec-3-4"><span class="section-number-3">3.4</span> Status</h3>
<div class="outline-text-3" id="text-3-4">
<p>
This is a beta release, but is now nearly feature complete. The core lentic
libraries should hopefully be fairly stable now, however, there is the
possibility that it will behave badly and may result in data loss. Please
use with care on files with backups.
</p>

<p>
Previous releases of this package were called "linked-buffer". I changed
this because I wanted a name for the general idea of text with two
visualisations; "linked text" doesn't work because it is sounds like
hyperlinked text.
</p>

<p>
Although it is still too early to guarantee, I hope that the current
configuration scheme will remain fixed, and subclass extensions should
require little change for the future.
</p>
</div>
</div>

<div id="outline-container-sec-3-5" class="outline-3">
<h3 id="sec-3-5"><span class="section-number-3">3.5</span> Code</h3>
<div class="outline-text-3" id="text-3-5">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">require</span> '<span style="color: #7fffd4;">eieio</span>)
(<span style="color: #00ffff;">require</span> '<span style="color: #7fffd4;">m-buffer</span>)
(<span style="color: #00ffff;">require</span> '<span style="color: #7fffd4;">m-buffer-at</span>)
(<span style="color: #00ffff;">require</span> '<span style="color: #7fffd4;">f</span>)

(<span style="color: #00ffff;">defvar</span> <span style="color: #eedd82;">lentic-doc</span> <span style="color: #ffa07a;">"lenticular.org"</span>)
</pre>
</div>
</div>

<div id="outline-container-sec-3-5-1" class="outline-4">
<h4 id="sec-3-5-1"><span class="section-number-4">3.5.1</span> State</h4>
<div class="outline-text-4" id="text-3-5-1">
<p>
This section defines all of the variables that the basic state for lentic
is stored in. We deliberately have as few of these as possible, as this
makes re-initializing the state during development as straight-forward as
possible.
</p>

<p>
We start with `lentic-init' which provides the ability to define some default
configuration for a buffer. These are just functions which return
`lentic-configuration' objects. This is a slight step of indirection but is
essentially there to allow the use of file- or dir-local variables to define
the default behaviour for a given buffer. All the values have to be defined by
the user as safe, so we do not want too many different values.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">defvar</span> <span style="color: #eedd82;">lentic-init</span> nil
  <span style="color: #ffa07a;">"Function that initializes lentics for this buffer.</span>

<span style="color: #ffa07a;">This should be one or a list of functions that each return a</span>
<span style="color: #ffa07a;">`</span><span style="color: #7fffd4;">lentic-configuration</span><span style="color: #ffa07a;">' object."</span>)

(make-variable-buffer-local 'lentic-init)
</pre>
</div>

<p>
The `lentic-config' variable stores all of the configuration objects for each
lentic-buffer of this-buffer. Each lentic-buffer should have one configuration
object and is this configuration object that controls the behaviour and
updating of that lentic. As lentics are bi-directional, the `lentic-config'
variable should be &#x2013; for each lentic-configuration object in this-buffer
pointing to that-buffer there should be one in that-buffer pointing to
this-buffer. This variable has to `permanent-local' otherwise a new mode (or
typing `normal-mode') would break everything.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">defvar</span> <span style="color: #eedd82;">lentic-config</span> nil
  <span style="color: #ffa07a;">"Configuration for lentic.</span>

<span style="color: #ffa07a;">This is a list of objects of the class `</span><span style="color: #7fffd4;">lentic-configuration</span><span style="color: #ffa07a;">'</span>
<span style="color: #ffa07a;">lentic-configuration', which defines the way in which the text in</span>
<span style="color: #ffa07a;">the different buffers is kept synchronized. This configuration is</span>
<span style="color: #ffa07a;">resilient to changes of mode in the current buffer."</span>)

(make-variable-buffer-local 'lentic-config)
(put 'lentic-config 'permanent-local t)

(<span style="color: #00ffff;">defvar</span> <span style="color: #eedd82;">lentic-counter</span> 0)
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-config-name</span> (buffer)
  <span style="color: #ffa07a;">"Given BUFFER, return a name for the configuration object."</span>
  (format <span style="color: #ffa07a;">"lentic \"%s:%s\""</span> buffer (<span style="color: #00ffff;">setq</span> lentic-counter (+ 1 lentic-counter))))

(<span style="color: #00ffff;">defvar</span> <span style="color: #eedd82;">lentic-init-functions</span> nil
  <span style="color: #ffa07a;">"All functions that can be used as `</span><span style="color: #7fffd4;">lentic-init</span><span style="color: #ffa07a;">' function."</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-5-2" class="outline-4">
<h4 id="sec-3-5-2"><span class="section-number-4">3.5.2</span> Base Configuration</h4>
<div class="outline-text-4" id="text-3-5-2">
<p>
This section defines the base class and generic methods for all
lentic-configuration objects. Most of the properties of this class define the
behaviour of the lentic-buffer &#x2013; in other words they are configuration.
However, there are a few properties which store state about the last
before-change event that occured which are used to percolate the changes
correctly. This is a handy place to store these, but are not really
end-user properties.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">defclass</span> <span style="color: #98fb98;">lentic-configuration</span> ()
  ((this-buffer
    <span style="color: #b0c4de;">:initarg</span> <span style="color: #b0c4de;">:this-buffer</span>
    <span style="color: #b0c4de;">:documentation</span>
    <span style="color: #ffa07a;">"The this-buffer for this configuration. This should be the</span>
<span style="color: #ffa07a;">    current-buffer when this configuration is present in `</span><span style="color: #7fffd4;">lentic-config</span><span style="color: #ffa07a;">'."</span> )
   (that-buffer
    <span style="color: #b0c4de;">:initarg</span> <span style="color: #b0c4de;">:that-buffer</span>
    <span style="color: #b0c4de;">:documentation</span>
    <span style="color: #ffa07a;">"The that-buffer for this configuration. The that-buffer (if</span>
<span style="color: #ffa07a;">    live) should a lentic-configuration object for this-buffer in</span>
<span style="color: #ffa07a;">    its `</span><span style="color: #7fffd4;">lentic-config</span><span style="color: #ffa07a;">'."</span> )
   (creator
    <span style="color: #b0c4de;">:initarg</span> <span style="color: #b0c4de;">:creator</span>
    <span style="color: #b0c4de;">:initform</span> nil
    <span style="color: #b0c4de;">:documentation</span>
    <span style="color: #ffa07a;">"Non-nil if this lentic-configuration was used to create a</span>
<span style="color: #ffa07a;">    lentic view. This is used to determine the behaviour when the</span>
<span style="color: #ffa07a;">    buffer is killed: killing the creator kills all views, but killing</span>
<span style="color: #ffa07a;">    a view does not kill the creator."</span>)
   (delete-on-exit
    <span style="color: #b0c4de;">:initarg</span> <span style="color: #b0c4de;">:delete-on-exit</span>
    <span style="color: #b0c4de;">:initform</span> nil
    <span style="color: #b0c4de;">:documentation</span>
    <span style="color: #ffa07a;">"Non-nil if the file associated with this should be deleted on exit."</span>)
   (singleton
    <span style="color: #b0c4de;">:initarg</span> <span style="color: #b0c4de;">:singleton</span>
    <span style="color: #b0c4de;">:initform</span> nil
    <span style="color: #b0c4de;">:documentation</span>
    <span style="color: #ffa07a;">"Non-nil if only one lentic (and therefore object) of this type</span>
<span style="color: #ffa07a;">    can exist for a given buffer."</span>)
   (sync-point
    <span style="color: #b0c4de;">:initarg</span> <span style="color: #b0c4de;">:sync-point</span>
    <span style="color: #b0c4de;">:initform</span> t
    <span style="color: #b0c4de;">:documentation</span>
    <span style="color: #ffa07a;">"Non-nil if changes to the location of point in this-buffer</span>
<span style="color: #ffa07a;">    should be percolated into that-buffer."</span>)
   (last-change-start
    <span style="color: #b0c4de;">:initarg</span> <span style="color: #b0c4de;">:last-change-start</span>
    <span style="color: #b0c4de;">:initform</span> nil
    <span style="color: #b0c4de;">:documentation</span>
    <span style="color: #ffa07a;">"The location of the start of the last before-change event.</span>
<span style="color: #ffa07a;">    This should only be set by lentic."</span>)
   (last-change-start-converted
    <span style="color: #b0c4de;">:initarg</span> <span style="color: #b0c4de;">:last-change-start-converted</span>
    <span style="color: #b0c4de;">:initform</span> nil
    <span style="color: #b0c4de;">:documentation</span>
    <span style="color: #ffa07a;">"The location of the start of the last before-change event,</span>
<span style="color: #ffa07a;">    converted into the equivalent location in that-buffer. This</span>
<span style="color: #ffa07a;">    should only be set by lentic."</span>)
   (last-change-stop
    <span style="color: #b0c4de;">:initarg</span> <span style="color: #b0c4de;">:last-change-stop</span>
    <span style="color: #b0c4de;">:initform</span> nil
    <span style="color: #b0c4de;">:documentation</span>
    <span style="color: #ffa07a;">"The location of the stop of the last before-change event.</span>
<span style="color: #ffa07a;">    This should only be set by lentic."</span> )
   (last-change-stop-converted
    <span style="color: #b0c4de;">:initarg</span> <span style="color: #b0c4de;">:last-change-stop-converted</span>
    <span style="color: #b0c4de;">:initform</span> nil
    <span style="color: #ffa07a;">"The location of the stop of the last before-change event,</span>
<span style="color: #ffa07a;">    converted into the equivalent location in that-buffer. This</span>
<span style="color: #ffa07a;">    should only be set by lentic."</span>))
  <span style="color: #ffa07a;">"Configuration object for lentic which defines the behavior of</span>
<span style="color: #ffa07a;">  the lentic buffer."</span>)
</pre>
</div>

<p>
We define a set of generic methods. I am not entirely sure what the purpose of
generic methods are and whether I need them or not; I think it's just a place
to put the documentation.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">defgeneric</span> <span style="color: #87cefa;">lentic-create</span> (conf)
  <span style="color: #ffa07a;">"Create the lentic for this configuration.</span>
<span style="color: #ffa07a;">Given a `</span><span style="color: #7fffd4;">lentic-configuration</span><span style="color: #ffa07a;">' object, create the lentic</span>
<span style="color: #ffa07a;">appropriate for that configurationuration. It is the callers</span>
<span style="color: #ffa07a;">responsibility to check that buffer has not already been</span>
<span style="color: #ffa07a;">created."</span>)

(<span style="color: #00ffff;">defgeneric</span> <span style="color: #87cefa;">lentic-convert</span> (conf location)
  <span style="color: #ffa07a;">"Convert LOCATION in this-buffer to an equivalent location in</span>
<span style="color: #ffa07a;">that-buffer. LOCATION is a numeric location, rather than a</span>
<span style="color: #ffa07a;">marker. By equivalent, we mean the same semantic location as</span>
<span style="color: #ffa07a;">determined by the transformation between the buffers. It is</span>
<span style="color: #ffa07a;">possible that a given LOCATION could map to more than one</span>
<span style="color: #ffa07a;">location in the lentic buffer."</span>)

(<span style="color: #00ffff;">defgeneric</span> <span style="color: #87cefa;">lentic-clone</span> (conf)
  <span style="color: #ffa07a;">"Updates that-buffer to reflect the contents in this-buffer.</span>

<span style="color: #ffa07a;">Updates at least the region that has been given between start and</span>
<span style="color: #ffa07a;">stop in the this-buffer, into the region start-converted and</span>
<span style="color: #ffa07a;">stop-converted in that-buffer.</span>

<span style="color: #ffa07a;">Returns a list of the start location in that-buffer of the</span>
<span style="color: #ffa07a;">change, the stop location in that-buffer of the change and the</span>
<span style="color: #ffa07a;">length-before in that buffer of the region changed before the</span>
<span style="color: #ffa07a;">change, if and only if the changes are exactly that suggested by</span>
<span style="color: #ffa07a;">the START, STOP, _LENGTH-BEFORE, START-CONVERTED and</span>
<span style="color: #ffa07a;">STOP-CONVERTED. Otherwise, this should return nil."</span>)
</pre>
</div>

<p>
We need an invert method because we can create the configuration object for a
this-buffer without actually creating that-buffer. This may happen at any
point in the future. So, the configuration object needs to be able to return
it's own inverse. This can be a configuration object of the same class which
is normal when the lentic transformation is symmetrical, or a different class
which is normal when the lentic transformation is asymmetrical.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">defgeneric</span> <span style="color: #87cefa;">lentic-invert</span> (conf)
  <span style="color: #ffa07a;">"Return a new configuration object for the lentic buffer.</span>
<span style="color: #ffa07a;">This method is called at the time that the lentic is created. It</span>
<span style="color: #ffa07a;">is the callers responsibility to ensure that this is only called</span>
<span style="color: #ffa07a;">at creation time and not subsequently. The invert function should</span>
<span style="color: #ffa07a;">only return the configuration object and NOT create the lentic</span>
<span style="color: #ffa07a;">buffer."</span>)
</pre>
</div>

<p>
`lentic-coexist?' has been created to cope with the case when a buffer has two
or more default views. We may wish to re-initialize all the default lentic
views. However, this is going to be problematic if some are already there &#x2013;
we will end up with two many. In general, configurations which have been
created as a result of calls to the `lentic-init' functions should return
false here if there is another call to the same function. Lentic buffers which
are being used as a persistent view should generally return true here so that
as many can be created as required.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">defgeneric</span> <span style="color: #87cefa;">lentic-coexist?</span> (this-conf that-conf)
  <span style="color: #ffa07a;">"Return non-nil if THIS-CONF and co-exist with THAT-CONF.</span>
<span style="color: #ffa07a;">By co-exist this means that both configurations are valid for a</span>
<span style="color: #ffa07a;">given buffer at the same time. A nil return indicates that there</span>
<span style="color: #ffa07a;">should only be one of these two for a given buffer."</span>)
</pre>
</div>

<p>
I've implemented `lentic-this' and `lentic-that' as methods although I think I
have only over-ridden the implementation once in lentic-delayed which has
since been deleted anyway.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">defmethod</span> <span style="color: #87cefa;">lentic-this</span> ((conf lentic-configuration))
  <span style="color: #ffa07a;">"Returns this-buffer for this configuration object.</span>
<span style="color: #ffa07a;">In most cases, this is likely to be the `</span><span style="color: #7fffd4;">current-buffer</span><span style="color: #ffa07a;">' but</span>
<span style="color: #ffa07a;">this should not be relied on."</span>
  (<span style="color: #00ffff;">oref</span> conf <span style="color: #b0c4de;">:this-buffer</span>))

(<span style="color: #00ffff;">defmethod</span> <span style="color: #87cefa;">lentic-that</span> ((conf lentic-configuration))
  <span style="color: #ffa07a;">"Returns the that-buffer for this configuration object.</span>
<span style="color: #ffa07a;">This may return nil if there is not that-buffer, probably because</span>
<span style="color: #ffa07a;">it has not been created."</span>
  (<span style="color: #00ffff;">and</span> (slot-boundp conf <span style="color: #b0c4de;">:that-buffer</span>)
       (<span style="color: #00ffff;">oref</span> conf <span style="color: #b0c4de;">:that-buffer</span>)))

(<span style="color: #00ffff;">defmethod</span> <span style="color: #87cefa;">lentic-ensure-that</span> ((conf lentic-configuration))
  <span style="color: #ffa07a;">"Get the lentic for this configuration</span>
<span style="color: #ffa07a;">or create it if it does not exist."</span>
  (<span style="color: #00ffff;">or</span> (lentic-that conf)
      (lentic-create conf)))
</pre>
</div>

<p>
This part of the user interface is not ideal at the moment. I need something
which allows me to see all the currently active lentic-buffers, but I am far
from convinced that the mode-line is the best place, since the mode-line gets
overly full for most users.
</p>

<p>
As a second problem, supporting mode-line display directly in the
configuration object seems right, and breaks the encapsulation between
lentic.el and lentic-mode.el. Probably this needs to be replaced by some sort
of status keyword return value.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">defmethod</span> <span style="color: #87cefa;">lentic-mode-line-string</span> ((conf lentic-configuration))
  <span style="color: #ffa07a;">"Returns a mode-line string for this configuration object."</span>
  (<span style="color: #00ffff;">when</span> (slot-boundp conf <span style="color: #b0c4de;">:that-buffer</span>)
    (<span style="color: #00ffff;">let</span> ((that (<span style="color: #00ffff;">oref</span> conf <span style="color: #b0c4de;">:that-buffer</span>)))
      (<span style="color: #00ffff;">if</span>
          (<span style="color: #00ffff;">and</span> that
               (buffer-live-p that))
          <span style="color: #ffa07a;">"on"</span>
        <span style="color: #ffa07a;">""</span>))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-5-3" class="outline-4">
<h4 id="sec-3-5-3"><span class="section-number-4">3.5.3</span> Default Configuration</h4>
<div class="outline-text-4" id="text-3-5-3">
<p>
This is the default implementation of a lentic configuration. It provides an
identity transformation at that string level &#x2013; the two buffers will (should!)
have identical `buffer-string' at all times. Or, more strictly, identical
without properties, so identical <code>(buffer-substring-no-properties (point-min)
(point-max))</code>, which is not nearly so snappy.
</p>

<p>
We add two more properties to this class &#x2013; perhaps these should be pushed upwards.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">defclass</span> <span style="color: #98fb98;">lentic-default-configuration</span> (lentic-configuration)
  ((lentic-file
    <span style="color: #b0c4de;">:initform</span> nil
    <span style="color: #b0c4de;">:initarg</span> <span style="color: #b0c4de;">:lentic-file</span>
    <span style="color: #b0c4de;">:documentation</span>
    <span style="color: #ffa07a;">"The name of the file that will be associated with that lentic buffer."</span>)
   (lentic-mode
    <span style="color: #b0c4de;">:initform</span> nil
    <span style="color: #b0c4de;">:initarg</span> <span style="color: #b0c4de;">:lentic-mode</span>
    <span style="color: #b0c4de;">:documentation</span>
    <span style="color: #ffa07a;">"The mode for that lentic buffer."</span>))
  <span style="color: #ffa07a;">"Configuration which maintains two lentics with the same contents."</span>)
</pre>
</div>

<p>
We add in a string transformation function here. There has no actual
function within lentic per se, but it is used in lentic-dev as something we
can advice. This avoids bulking up the code in lentic, while still allows
me to affect the transformation during development of new transforms.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-insertion-string-transform</span> (string)
  <span style="color: #ffa07a;">"Transform the STRING that is about to be inserted.</span>
<span style="color: #ffa07a;">This function is not meant to do anything. It's useful to</span>
<span style="color: #ffa07a;">advice."</span>
  string)
</pre>
</div>

<p>
The default methods should be self-explanatory!
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">defmethod</span> <span style="color: #87cefa;">lentic-create</span> ((conf lentic-default-configuration))
  <span style="color: #ffa07a;">"Create an new lentic buffer. This creates the new buffer sets</span>
<span style="color: #ffa07a;">the mode to the same as the main buffer or which ever is</span>
<span style="color: #ffa07a;">specified in the configuration. The current contents of the main</span>
<span style="color: #ffa07a;">buffer are copied."</span>
  <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">make sure the world is ready for lentic buffers</span>
  (lentic-ensure-hooks)
  <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">create lentic</span>
  (<span style="color: #00ffff;">let*</span> ((this-buffer
          (lentic-this conf))
         (that-buffer
          (generate-new-buffer
           (format <span style="color: #ffa07a;">"*lentic: %s*"</span>
                   (buffer-name
                    this-buffer))))
         (sec-file (<span style="color: #00ffff;">oref</span> conf <span style="color: #b0c4de;">:lentic-file</span>))
         (sec-mode
          (<span style="color: #00ffff;">or</span>
           <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">the specified normal mode</span>
           (<span style="color: #00ffff;">oref</span> conf <span style="color: #b0c4de;">:lentic-mode</span>)
           <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">if we have a file try normal mode</span>
           (<span style="color: #00ffff;">if</span> sec-file
               'normal-mode
             <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">otherwise the same mode as the main file</span>
             major-mode))))
    (<span style="color: #00ffff;">oset</span> conf <span style="color: #b0c4de;">:creator</span> t)
    <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">make sure this-buffer knows about that-buffer</span>
    (<span style="color: #00ffff;">oset</span> conf <span style="color: #b0c4de;">:that-buffer</span> that-buffer)
    <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">init that-buffer with mode, file and config</span>
    <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">the mode must be init'd after adding content in case there are any</span>
    <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">file-local variables need to be evaled</span>
    <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">insert the contents</span>
    (lentic-update-contents conf)
    (<span style="color: #00ffff;">with-current-buffer</span> that-buffer
      (<span style="color: #00ffff;">when</span> sec-mode
        (funcall sec-mode))
      (<span style="color: #00ffff;">when</span> sec-file
        (set-visited-file-name sec-file))
      (<span style="color: #00ffff;">setq</span> lentic-config
            (list (lentic-invert conf))))
    that-buffer))

(<span style="color: #00ffff;">defmethod</span> <span style="color: #87cefa;">lentic-coexist?</span> ((this-conf lentic-default-configuration)
                            that-conf)
  <span style="color: #ffa07a;">"By default, we can have multiple lentic buffers with the same</span>
<span style="color: #ffa07a;">configuration, unless specifically disallowed, or unless it has</span>
<span style="color: #ffa07a;">the same associated file as pre-existing buffer (which is going</span>
<span style="color: #ffa07a;">to break!)."</span>
  (<span style="color: #00ffff;">and</span>
   (not (<span style="color: #00ffff;">oref</span> this-conf <span style="color: #b0c4de;">:singleton</span>))
   (not
    (<span style="color: #00ffff;">and</span> (<span style="color: #00ffff;">oref</span> this-conf <span style="color: #b0c4de;">:lentic-file</span>)
         (<span style="color: #00ffff;">oref</span> that-conf <span style="color: #b0c4de;">:lentic-file</span>)
         (f-equal? (<span style="color: #00ffff;">oref</span> this-conf <span style="color: #b0c4de;">:lentic-file</span>)
                   (<span style="color: #00ffff;">oref</span> that-conf <span style="color: #b0c4de;">:lentic-file</span>))))))

(<span style="color: #00ffff;">defmethod</span> <span style="color: #87cefa;">lentic-invert</span> ((conf lentic-default-configuration))
  <span style="color: #ffa07a;">"By default, return a clone of the existing object, but switch</span>
<span style="color: #ffa07a;">the this and that buffers around. "</span>
  (clone
   conf
   <span style="color: #b0c4de;">:this-buffer</span> (lentic-that conf)
   <span style="color: #b0c4de;">:that-buffer</span> (lentic-this conf)
   <span style="color: #b0c4de;">:sync-point</span> (<span style="color: #00ffff;">oref</span> conf <span style="color: #b0c4de;">:sync-point</span>)))

(<span style="color: #00ffff;">defmethod</span> <span style="color: #87cefa;">lentic-convert</span> ((conf lentic-default-configuration)
                           location)
  <span style="color: #ffa07a;">"The two buffers should be identical, so we just return the</span>
<span style="color: #ffa07a;">  same location."</span>
  location)

(<span style="color: #00ffff;">defmethod</span> <span style="color: #87cefa;">lentic-clone</span> ((conf lentic-configuration)
                                <span style="color: #98fb98;">&amp;optional</span> start stop _length-before
                                start-converted stop-converted)
  <span style="color: #ffa07a;">"The default clone method cuts out the before region and pastes</span>
<span style="color: #ffa07a;">in the new."</span>
  (<span style="color: #00ffff;">let</span> ((this-b (lentic-this conf))
        (that-b (lentic-that conf)))
    (<span style="color: #00ffff;">with-current-buffer</span> this-b
      <span style="color: #ff7f24;">;;</span><span style="color: #ff7f24;">(lentic-log "this-b (point,start,stop)(%s,%s,%s)" (point) start stop)</span>
      (<span style="color: #00ffff;">save-window-excursion</span>
        (<span style="color: #00ffff;">save-restriction</span>
          (widen)
          (<span style="color: #00ffff;">let*</span> ((start (<span style="color: #00ffff;">or</span> start (point-min)))
                 (stop (<span style="color: #00ffff;">or</span> stop (point-max))))
            (<span style="color: #00ffff;">with-current-buffer</span> that-b
              (<span style="color: #00ffff;">save-restriction</span>
                (widen)
                <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">get the start location that we converted before the change.</span>
                <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">lentic-convert is not reliable now, because the two</span>
                <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">buffers do not share state until we have percolated it</span>
                (<span style="color: #00ffff;">let</span> ((converted-start
                       (max (point-min)
                            (<span style="color: #00ffff;">or</span> start-converted
                                (point-min))))
                      (converted-stop
                       (min (point-max)
                            (<span style="color: #00ffff;">or</span> stop-converted
                                (point-max)))))
                  (delete-region converted-start
                                 converted-stop)
                  (<span style="color: #00ffff;">save-excursion</span>
                    (goto-char converted-start)
                    <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">so this insertion is happening at the wrong place in bloc</span><span style="color: #ee82ee; background-color: #333333;">k</span>
                    <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">comment -- in fact, it's happening one too early</span>
                    (insert
                     (<span style="color: #00ffff;">with-current-buffer</span> this-b
                       <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">want to see where it goes</span>
                       <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">hence the property</span>
                       (lentic-insertion-string-transform
                        (buffer-substring-no-properties
                         start stop))))
                    (list converted-start
                          (+ converted-start (- stop start))
                          (- converted-stop converted-start))))))))))))

<span style="color: #ff7f24;">;;;</span><span style="color: #ff7f24;">###</span><span style="color: #ffc0cb; font-weight: bold;">autoload</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-default-init</span> ()
  <span style="color: #ffa07a;">"Default init function.</span>
<span style="color: #ffa07a;">see `</span><span style="color: #7fffd4;">lentic-init</span><span style="color: #ffa07a;">' for details."</span>
  (lentic-default-configuration
   (lentic-config-name (current-buffer))
   <span style="color: #b0c4de;">:this-buffer</span> (current-buffer)))

(add-to-list 'lentic-init-functions
             'lentic-default-init)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-5-4" class="outline-4">
<h4 id="sec-3-5-4"><span class="section-number-4">3.5.4</span> Basic Operation</h4>
<div class="outline-text-4" id="text-3-5-4">
<p>
In this section, we define some utility functions and the hooks we need into
the core Emacs operations.
</p>
</div>

<ol class="org-ol"><li><a id="sec-3-5-4-1" name="sec-3-5-4-1"></a>Utility<br  /><div class="outline-text-5" id="text-3-5-4-1">
<p>
We start with some utility macros. These deal with the fact that a buffer can
have a lentic or not, and that even if it does that lentic does not need to be
live. This happens for instance if a lentic buffer is deleted &#x2013; the buffer
object will still be live (because the configuration object hangs on to it).
</p>

<p>
At some point, the hook system needs to clean this up by detecting the
buffer-kill and removing the configuration objection.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">defmacro</span> <span style="color: #87cefa;">lentic-when-lentic</span> (<span style="color: #98fb98;">&amp;rest</span> body)
  <span style="color: #ffa07a;">"Evaluate BODY when the `</span><span style="color: #7fffd4;">current-buffer</span><span style="color: #ffa07a;">' has a lentic buffer."</span>
  (<span style="color: #00ffff;">declare</span> (debug t))
  `(<span style="color: #00ffff;">when</span> (<span style="color: #00ffff;">and</span>
          lentic-config
          (<span style="color: #00ffff;">-any?</span>
           (<span style="color: #00ffff;">lambda</span> (conf)
             (<span style="color: #00ffff;">-when-let</span>
                 (buf (lentic-that conf))
               (buffer-live-p buf)))
           lentic-config))
     ,@body))

(<span style="color: #00ffff;">defmacro</span> <span style="color: #87cefa;">lentic-when-buffer</span> (buffer <span style="color: #98fb98;">&amp;rest</span> body)
  <span style="color: #ffa07a;">"When BUFFER is a live buffer eval BODY."</span>
  (<span style="color: #00ffff;">declare</span> (debug t)
           (indent 1))
  `(<span style="color: #00ffff;">when</span> (<span style="color: #00ffff;">and</span> ,buffer
              (buffer-live-p ,buffer))
     ,@body))

(<span style="color: #00ffff;">defmacro</span> <span style="color: #87cefa;">lentic-when-with-current-buffer</span> (buffer <span style="color: #98fb98;">&amp;rest</span> body)
  <span style="color: #ffa07a;">"When BUFFER is a live buffer eval BODY with BUFFER current."</span>
  (<span style="color: #00ffff;">declare</span> (debug t)
           (indent 1))
  `(<span style="color: #00ffff;">lentic-when-buffer</span>
    ,buffer
    (<span style="color: #00ffff;">with-current-buffer</span>
        ,buffer
      ,@body)))

(<span style="color: #00ffff;">defmacro</span> <span style="color: #87cefa;">lentic-with-lentic-buffer</span> (buffer <span style="color: #98fb98;">&amp;rest</span> body)
  <span style="color: #ffa07a;">"With BUFFER as current, eval BODY when BUFFER has a lentic."</span>
  (<span style="color: #00ffff;">declare</span> (debug t)
           (indent 1))
  `(<span style="color: #00ffff;">lentic-when-with-current-buffer</span>
       buffer
     (<span style="color: #00ffff;">when</span> lentic-config
       ,@body)))


(<span style="color: #00ffff;">defvar</span> <span style="color: #eedd82;">lentic-condition-case-disabled</span>
  noninteractive
  <span style="color: #ffa07a;">"If non-nil throw exceptions from errors.</span>

<span style="color: #ffa07a;">By default this is set to the value of noninteractive, so that</span>
<span style="color: #ffa07a;">Emacs crashes with backtraces in batch."</span> )

(<span style="color: #00ffff;">defmacro</span> <span style="color: #87cefa;">lentic-condition-case-unless-disabled</span> (var bodyform <span style="color: #98fb98;">&amp;rest</span> handlers)
  <span style="color: #ffa07a;">"Like `</span><span style="color: #7fffd4;">condition-case</span><span style="color: #ffa07a;">' but can be disabled like `</span><span style="color: #7fffd4;">condition-case-unless-debug</span><span style="color: #ffa07a;">'.</span><span style="color: #ee82ee; background-color: #333333;">"</span>
  (<span style="color: #00ffff;">declare</span> (debug condition-case) (indent 2))
  `(<span style="color: #00ffff;">if</span> lentic-condition-case-disabled
       ,bodyform
     (<span style="color: #00ffff;">condition-case-unless-debug</span> ,var
         ,bodyform
       ,@handlers)))

(<span style="color: #00ffff;">defmacro</span> <span style="color: #87cefa;">lentic-widen</span> (conf <span style="color: #98fb98;">&amp;rest</span> body)
  <span style="color: #ffa07a;">"Widen both buffers in CONF, then evaluate BODY."</span>
  (<span style="color: #00ffff;">declare</span> (debug t)
           (indent 1))
  `(<span style="color: #00ffff;">with-current-buffer</span>
       (lentic-that ,conf)
     (<span style="color: #00ffff;">save-restriction</span>
       (widen)
       (<span style="color: #00ffff;">with-current-buffer</span>
           (lentic-this ,conf)
         (<span style="color: #00ffff;">save-restriction</span>
           (widen)
           ,@body)))))
</pre>
</div>

<p>
Recurse down the lentic tree to all lentic views.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-each</span> (buffer fn <span style="color: #98fb98;">&amp;optional</span> seen-buffer)
  <span style="color: #ffa07a;">"Starting at BUFFER, call FN on every lentic-buffer.</span>
<span style="color: #ffa07a;">FN should take a single argument which is the buffer.</span>
<span style="color: #ffa07a;">SEEN-BUFFER is a list of buffers to ignore."</span>
  (<span style="color: #00ffff;">lentic-with-lentic-buffer</span> buffer
    (<span style="color: #00ffff;">setq</span> seen-buffer (cons buffer seen-buffer))
    (<span style="color: #00ffff;">-map</span>
     (<span style="color: #00ffff;">lambda</span> (conf)
       (<span style="color: #00ffff;">let</span> ((that
              (lentic-that conf)))
         (<span style="color: #00ffff;">when</span> (<span style="color: #00ffff;">and</span> (not (<span style="color: #00ffff;">-contains?</span> seen-buffer that))
                  (buffer-live-p that))
           (funcall fn that)
           (lentic-each that fn seen-buffer))))
     lentic-config)))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-garbage-collect-config</span> ()
  <span style="color: #ffa07a;">"Remove non-live configs in current-buffer."</span>
  (<span style="color: #00ffff;">setq</span> lentic-config
        (<span style="color: #00ffff;">--filter</span>
         (buffer-live-p
          (lentic-that <span style="color: #eedd82;">it</span>))
         lentic-config)))
</pre>
</div>
</div>
</li>

<li><a id="sec-3-5-4-2" name="sec-3-5-4-2"></a>Initialisation<br  /><div class="outline-text-5" id="text-3-5-4-2">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-ensure-init</span> ()
  <span style="color: #ffa07a;">"Ensure that the `</span><span style="color: #7fffd4;">lentic-init</span><span style="color: #ffa07a;">' has been run."</span>
  (lentic-garbage-collect-config)
  (<span style="color: #00ffff;">setq</span> lentic-config
        <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">and attach to lentic-config</span>
        (<span style="color: #00ffff;">-concat</span>
         lentic-config
         <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">return only those that can co-exist</span>
         (<span style="color: #00ffff;">-filter</span>
          (<span style="color: #00ffff;">lambda</span> (this-conf)
            (<span style="color: #00ffff;">-all?</span>
             (<span style="color: #00ffff;">lambda</span> (that-conf)
               (lentic-coexist? this-conf that-conf))
             lentic-config))
          (<span style="color: #00ffff;">-map</span>
           (<span style="color: #00ffff;">lambda</span> (init)
             <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">instantiate a new conf object (but do not create the buffer)</span>
             (funcall init))
           (<span style="color: #00ffff;">if</span> (not lentic-init)
               '(lentic-default-init)
             (<span style="color: #00ffff;">-list</span> lentic-init)))))))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-init-all-create</span> ()
  <span style="color: #ffa07a;">"Create all lentics fo the current buffer."</span>
  (lentic-ensure-init)
  (<span style="color: #00ffff;">-map</span>
   (<span style="color: #00ffff;">lambda</span> (conf)
     (<span style="color: #00ffff;">if</span> (<span style="color: #00ffff;">and</span>
          (slot-boundp conf <span style="color: #b0c4de;">:that-buffer</span>)
          (buffer-live-p
           (lentic-that conf)))
         (lentic-that conf)
       (lentic-create conf)))
   (<span style="color: #00ffff;">-list</span> lentic-config)))
</pre>
</div>
</div>
</li>

<li><a id="sec-3-5-4-3" name="sec-3-5-4-3"></a>Hook System<br  /><div class="outline-text-5" id="text-3-5-4-3">
<p>
The lentic hook system is relatively involved, unfortunately, and will
probably become more so. In so far as possible, though, all of the complexity
should be here, using the methods provided in the lentic-configuration object.
</p>

<p>
The complexity of the hook system and the fact that it is hooked deeply into
the core of Emacs can make it quite hard to debug. There are a number of
features put in place to help deal with this. These are:
</p>

<ul class="org-ul">
<li>A logging system
</li>
<li>An emergency detection system.
</li>
<li>Two part hooks
</li>
</ul>


<p>
Start by enabling hooks!
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-ensure-hooks</span> ()
  <span style="color: #ffa07a;">"Ensures that the hooks that this mode requires are in place."</span>
  (add-hook 'post-command-hook
            'lentic-post-command-hook)
  <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">after and before-change functions are hooks (with args) even if they are</span>
  <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">not named as such.</span>
  (add-hook 'after-change-functions
            'lentic-after-change-function)
  (add-hook 'before-change-functions
            'lentic-before-change-function)
  (add-hook 'after-save-hook
            'lentic-after-save-hook)
  (add-hook 'kill-buffer-hook
            'lentic-kill-buffer-hook)
  (add-hook 'kill-emacs-hook
            'lentic-kill-emacs-hook))
</pre>
</div>

<p>
The logging system which allows post-mortem analysis of what lentic has done.
Originally, my plan was to leave logging in place so aid analysis of bug
reports, but this requires so much logging that it the log buffer becomes
impossible to analyse.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">defvar</span> <span style="color: #eedd82;">lentic-log</span> t)
(<span style="color: #00ffff;">defmacro</span> <span style="color: #87cefa;">lentic-log</span> (<span style="color: #98fb98;">&amp;rest</span> rest)
  <span style="color: #ffa07a;">"Log REST."</span>
  `(<span style="color: #00ffff;">when</span> lentic-log
     (<span style="color: #00ffff;">lentic-when-lentic</span>
      (<span style="color: #00ffff;">let</span> ((msg
             (concat
              (format ,@rest)
              <span style="color: #ffa07a;">"\n"</span>)))
        (<span style="color: #00ffff;">with-current-buffer</span>
            (get-buffer-create <span style="color: #ffa07a;">"*lentic-log*"</span>)
          (goto-char (point-max))
          (insert msg))))))
</pre>
</div>

<p>
An emergency detection system. Several of the hooks in use (post-command-hook,
and the before- and after-change-functions) automatically remove hook
functions which give errors. In development, this means that all errors are
silently ignored and, worse, lentic continues in an inconsistent state with
some hooks working and some not. Lentic catches all errors, therefore, and
then drops into an "lentic-emergency" state, where all lentic functionality is
disabled. This is still a dangerous state as changes do not percolate, but at
least it should be predictable. The emergency state can be changed with
`lentic-unemergency' and `lentic-emergency'.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">defvar</span> <span style="color: #eedd82;">lentic-emergency</span>  nil
  <span style="color: #ffa07a;">"Iff non-nil halt all lentic activity.</span>

<span style="color: #ffa07a;">This is not the same as disabling lentic mode. It stops all</span>
<span style="color: #ffa07a;">lentic related activity in all buffers; this happens as a result</span>
<span style="color: #ffa07a;">of an error condition. If lentic was to carry on in these</span>
<span style="color: #ffa07a;">circumstances, serious data loss could occur. In normal use, this</span>
<span style="color: #ffa07a;">variable will only be set as a result of a problem with the code;</span>
<span style="color: #ffa07a;">it is not recoverable from a user perspective.</span>

<span style="color: #ffa07a;">It is useful to toggle this state on during development. Once</span>
<span style="color: #ffa07a;">enabled, buffers will not update automaticaly but only when</span>
<span style="color: #ffa07a;">explicitly told to. This is much easier than try to debug errors</span>
<span style="color: #ffa07a;">happening on the after-change-hooks. The</span>
<span style="color: #ffa07a;">function `</span><span style="color: #7fffd4;">lentic-emergency</span><span style="color: #ffa07a;">' and `</span><span style="color: #7fffd4;">lentic-unemergency</span><span style="color: #ffa07a;">' functions</span>
<span style="color: #ffa07a;">enable this."</span>)

(<span style="color: #00ffff;">defvar</span> <span style="color: #eedd82;">lentic-emergency-debug</span> nil
  <span style="color: #ffa07a;">"Iff non-nil, lentic will store change data, even</span>
<span style="color: #ffa07a;">during a `</span><span style="color: #7fffd4;">lentic-emergency</span><span style="color: #ffa07a;">'.</span>

<span style="color: #ffa07a;">Normally, `</span><span style="color: #7fffd4;">lentic-emergency</span><span style="color: #ffa07a;">' disables all activity, but this makes</span>
<span style="color: #ffa07a;">testing incremental changes charge. With this variable set, lentic will</span>
<span style="color: #ffa07a;">attempt to store enough change data to operate manually. This does require</span>
<span style="color: #ffa07a;">running some lentic code (notably `</span><span style="color: #7fffd4;">lentic-convert</span><span style="color: #ffa07a;">'). This is low</span>
<span style="color: #ffa07a;">risk code, but may still be buggy, and so setting this variable can cause</span>
<span style="color: #ffa07a;">repeated errors."</span>)

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-emergency</span> ()
  <span style="color: #ffa07a;">"Stop lentic from working due to code problem."</span>
  (<span style="color: #00ffff;">interactive</span>)
  (<span style="color: #00ffff;">setq</span> lentic-emergency t)
  (lentic-update-all-display))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-unemergency</span> ()
  <span style="color: #ffa07a;">"Start lentic working after stop due to code problem."</span>
  (<span style="color: #00ffff;">interactive</span>)
  (<span style="color: #00ffff;">setq</span> lentic-emergency nil)
  (lentic-update-all-display))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-hook-fail</span> (err hook)
  <span style="color: #ffa07a;">"Give an informative message when we have to fail.</span>
<span style="color: #ffa07a;">ERR is the error. HOOK is the hook type."</span>
  (message <span style="color: #ffa07a;">"lentic mode has failed on \"%s\" hook: %s "</span>
           hook (error-message-string err))
  (lentic-emergency)
  (<span style="color: #00ffff;">with-output-to-temp-buffer</span> <span style="color: #ffa07a;">"*lentic-fail*"</span>
    (princ <span style="color: #ffa07a;">"There has been an error in lentic-mode.\n"</span>)
    (princ <span style="color: #ffa07a;">"The following is debugging information\n\n"</span>)
    (princ (format <span style="color: #ffa07a;">"Hook: %s\n"</span> hook))
    (princ (error-message-string err)))
  (select-window (get-buffer-window <span style="color: #ffa07a;">"*lentic-fail*"</span>)))
</pre>
</div>

<p>
As a byproduct of the last, lentic also has two part hooks: the real hook
function which just handles errors and calls the second function which does
the work. This make it possible to call the second function interactively,
without catching errors (so that they can be debugged) or causing the
lentic-emergency state. There are some utility functions in lentic-dev for
running hooks which require arguments.
</p>
</div>

<ol class="org-ol"><li><a id="sec-3-5-4-3-1" name="sec-3-5-4-3-1"></a>General Hook<br  /><div class="outline-text-6" id="text-3-5-4-3-1">
<p>
Start by handling saving, killing and general connecting with the Emacs
behaviour.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-after-save-hook</span> ()
  <span style="color: #ffa07a;">"Error protected call to real after save hook."</span>
  (<span style="color: #00ffff;">unless</span> lentic-emergency
    (<span style="color: #00ffff;">lentic-condition-case-unless-disabled</span> err
        (lentic-after-save-hook-1)
      (<span style="color: #ffc0cb; font-weight: bold;">error</span>
       (lentic-hook-fail err <span style="color: #ffa07a;">"after-save-hook"</span>)))))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-after-save-hook-1</span> ()
  <span style="color: #ffa07a;">"Respond to a save in the `</span><span style="color: #7fffd4;">current-buffer</span><span style="color: #ffa07a;">'.</span>
<span style="color: #ffa07a;">This also saves every lentic which is file-associated."</span>
  (lentic-each
   (current-buffer)
   (<span style="color: #00ffff;">lambda</span> (buffer)
     (<span style="color: #00ffff;">with-current-buffer</span>
         buffer
       (<span style="color: #00ffff;">when</span> (buffer-file-name)
         (save-buffer))))))

(<span style="color: #00ffff;">defvar</span> <span style="color: #eedd82;">lentic-kill-retain</span> nil
  <span style="color: #ffa07a;">"If non-nil retain files even if requested to delete on exit."</span>)

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-kill-buffer-hook</span> ()
  <span style="color: #ffa07a;">"Error protected call to real `</span><span style="color: #7fffd4;">kill-buffer-hook</span><span style="color: #ffa07a;">'."</span>
  (<span style="color: #00ffff;">unless</span> lentic-emergency
    (<span style="color: #00ffff;">lentic-condition-case-unless-disabled</span> err
        (lentic-kill-buffer-hook-1)
      (<span style="color: #ffc0cb; font-weight: bold;">error</span>
       (lentic-hook-fail err <span style="color: #ffa07a;">"kill-buffer-hook"</span>)))))

(<span style="color: #00ffff;">defvar</span> <span style="color: #eedd82;">lentic--killing-p</span> nil)

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-kill-buffer-hook-1</span> ()
  <span style="color: #ffa07a;">"Respond to any buffer being killed.</span>
<span style="color: #ffa07a;">If this killed buffer is lentic and is :creator, then kill all</span>
<span style="color: #ffa07a;">lentic-buffers recursively. If the buffer is :delete-on-exit,</span>
<span style="color: #ffa07a;">then remove any associated file."</span>
  (<span style="color: #00ffff;">lentic-when-lentic</span>
   (<span style="color: #00ffff;">when</span>
       (<span style="color: #00ffff;">and</span>
        (<span style="color: #00ffff;">--any?</span>
         (<span style="color: #00ffff;">oref</span> <span style="color: #eedd82;">it</span> <span style="color: #b0c4de;">:delete-on-exit</span>)
         lentic-config)
        <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">might not exist if we not saved yet!</span>
        (file-exists-p buffer-file-name)
        <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">if we are cloning in batch, we really do not want to kill</span>
        <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">everything at the end</span>
        (not noninteractive)
        <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">or we have blocked this anyway</span>
        (not lentic-kill-retain))
     (delete-file (buffer-file-name)))
   <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">if we were the creator buffer, blitz the lentics (which causes their</span>
   <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">files to delete also).</span>
   (<span style="color: #00ffff;">let</span> ((lentic-killing-p t))
     (<span style="color: #00ffff;">when</span>
         (<span style="color: #00ffff;">and</span>
          (not lentic-killing-p)
          (<span style="color: #00ffff;">--any?</span>
           (<span style="color: #00ffff;">oref</span> <span style="color: #eedd82;">it</span> <span style="color: #b0c4de;">:creator</span>)
           lentic-config))
       (lentic-each
        (current-buffer)
        (<span style="color: #00ffff;">lambda</span> (buffer)
          (kill-buffer buffer)))))))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-kill-emacs-hook</span> ()
  <span style="color: #ffa07a;">"Error protected call to real `</span><span style="color: #7fffd4;">kill-emacs-hook</span><span style="color: #ffa07a;">'."</span>
  (<span style="color: #00ffff;">unless</span> lentic-emergency
    (<span style="color: #00ffff;">lentic-condition-case-unless-disabled</span> err
        (lentic-kill-emacs-hook-1)
      (<span style="color: #ffc0cb; font-weight: bold;">error</span>
       (lentic-hook-fail err <span style="color: #ffa07a;">"kill-emacs-hook"</span>)))))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-kill-emacs-hook-1</span> ()
  <span style="color: #ffa07a;">"Respond to `kill-emacs-hook.</span>
<span style="color: #ffa07a;">This removes any files associated with lentics which are</span>
<span style="color: #ffa07a;">marked as :delete-on-exit."</span>
  (<span style="color: #00ffff;">-map</span>
   (<span style="color: #00ffff;">lambda</span> (buffer)
     (<span style="color: #00ffff;">lentic-with-lentic-buffer</span>
         buffer
       (<span style="color: #00ffff;">-map</span>
        (<span style="color: #00ffff;">lambda</span> (conf)
          (<span style="color: #00ffff;">and</span>
           (<span style="color: #00ffff;">oref</span> conf <span style="color: #b0c4de;">:delete-on-exit</span>)
           (file-exists-p buffer-file-name)
           (not noninteractive)
           (delete-file (buffer-file-name))))
        lentic-config)))
   (buffer-list)))
</pre>
</div>
</div>
</li>

<li><a id="sec-3-5-4-3-2" name="sec-3-5-4-3-2"></a>Change Hooks<br  /><div class="outline-text-6" id="text-3-5-4-3-2">
<p>
Handling and percolating changes is the most complex part of lentic, made more
complex still by the decision to support multiple buffers (why did I do that
to myself?).
</p>

<p>
The `post-command-hook' just percolates location of point through all the
lentic buffers.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-post-command-hook</span> ()
  <span style="color: #ffa07a;">"Update point according to config, with error handling."</span>
  (<span style="color: #00ffff;">unless</span> lentic-emergency
    (<span style="color: #00ffff;">lentic-condition-case-unless-disabled</span> err
        (<span style="color: #00ffff;">progn</span>
          <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">we test for this later anyway, but this makes it easier to debug.</span>
          (<span style="color: #00ffff;">when</span> lentic-config
            (lentic-post-command-hook-1 (current-buffer))))
      (<span style="color: #ffc0cb; font-weight: bold;">error</span>
       (lentic-hook-fail err <span style="color: #ffa07a;">"post-command-hook"</span>)))))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-post-command-hook-1</span> (buffer <span style="color: #98fb98;">&amp;optional</span> seen-buffer)
  <span style="color: #ffa07a;">"Update point in BUFFER according to config.</span>
<span style="color: #ffa07a;">SEEN-BUFFER is a list of lentics that have already been updated."</span>
  (<span style="color: #00ffff;">lentic-with-lentic-buffer</span>
      buffer
    <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">now we have seen this buffer don't look again</span>
    (<span style="color: #00ffff;">setq</span> seen-buffer (cons buffer seen-buffer))
    <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">for all configurations</span>
    (<span style="color: #00ffff;">-map</span>
     (<span style="color: #00ffff;">lambda</span> (config)
       (<span style="color: #00ffff;">let</span> ((that
              (lentic-that config)))
         <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">check for the termination condition</span>
         (<span style="color: #00ffff;">unless</span> (<span style="color: #00ffff;">-contains?</span> seen-buffer that)
           (<span style="color: #00ffff;">lentic-when-buffer</span>
               that
             <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">then update and recurse</span>
             (lentic-update-point config))
           (lentic-post-command-hook-1 (lentic-that config) seen-buffer))))
     lentic-config)))
</pre>
</div>

<p>
The `after-change-function' is by far the most complex of the hooks. This is because
we have to percolate the changes from the buffer that has changed as a result
of the user doing something to all the other buffers. In theory, this should be
straight-forward: combined with the `before-change-function', the data from
the `after-change-function' defines a "dirty region" which we need to update
by copying from the parent and then doing what ever transformation needs to
happen. The problem is that that the contract from the configuration objects'
`lentic-clone' method is that <b>at least</b> the dirty region will be replaced.
`lentic-clone' can actually replace much more than this, and often needs to do
so, to ensure a consistent transformation.
</p>

<p>
So, when a lentic-buffer updates it needs to update it's own dirty region but
also return the dirty region that it has created, so that any lentic buffers
that it in turn has that are still to be updated can be so. Or, if it doesn't,
we just assume the whole buffer is dirty which is safe but inefficient.
</p>

<p>
The main after-change-function also stores the its arguments if we are in
debug mode which allows me to run `lentic-after-change-function-1'
interactively with the correct arguments.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">defvar</span> <span style="color: #eedd82;">lentic-emergency-last-change</span> nil)
(make-variable-buffer-local 'lentic-emergency-last-change)

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-after-change-transform</span> (buffer start stop length-before)
  <span style="color: #ffa07a;">"Function called after every change percolated by lentic.</span>
<span style="color: #ffa07a;">This function does nothing and is meant for advising. See</span>
<span style="color: #ffa07a;">lentic-dev."</span>
)

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-after-change-function</span> (start stop length-before)
  <span style="color: #ffa07a;">"Run change update according to `</span><span style="color: #7fffd4;">lentic-config</span><span style="color: #ffa07a;">'.</span>
<span style="color: #ffa07a;">Errors are handled.</span>
<span style="color: #ffa07a;">START is at most the start of the change.</span>
<span style="color: #ffa07a;">STOP is at least the end of the change.</span>
<span style="color: #ffa07a;">LENGTH-BEFORE is the length of the area before the change."</span>
  <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">store values in case we want to use them</span>
  (<span style="color: #00ffff;">when</span> lentic-emergency-debug
    (<span style="color: #00ffff;">setq</span> lentic-emergency-last-change (list start stop length-before)))
  (<span style="color: #00ffff;">unless</span> lentic-emergency
    (<span style="color: #00ffff;">lentic-condition-case-unless-disabled</span> err
        (lentic-after-change-function-1
         (current-buffer) start stop length-before)
      (<span style="color: #ffc0cb; font-weight: bold;">error</span>
       (lentic-hook-fail err <span style="color: #ffa07a;">"after change"</span>)))))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-after-change-function-1</span>
    (buffer start stop
            length-before <span style="color: #98fb98;">&amp;optional</span> seen-buffer)
  <span style="color: #ffa07a;">"Run change update according to `</span><span style="color: #7fffd4;">lentic-config</span><span style="color: #ffa07a;">'.</span>
<span style="color: #ffa07a;">BUFFER is the changed buffer.</span>
<span style="color: #ffa07a;">START is at most the start of the change.</span>
<span style="color: #ffa07a;">STOP is at least the end of the change.</span>
<span style="color: #ffa07a;">LENGTH-BEFORE is the length of the area before the change.</span>
<span style="color: #ffa07a;">SEEN-BUFFER is a list of buffers to which we have already percolated</span>
<span style="color: #ffa07a;">the change."</span>
  (<span style="color: #00ffff;">lentic-with-lentic-buffer</span> buffer
    (<span style="color: #00ffff;">setq</span> seen-buffer (cons buffer seen-buffer))
    (<span style="color: #00ffff;">-map</span>
     (<span style="color: #00ffff;">lambda</span> (config)
       (<span style="color: #00ffff;">unless</span>
           (<span style="color: #00ffff;">or</span> (<span style="color: #00ffff;">-contains?</span> seen-buffer (lentic-that config))
               (not (buffer-live-p (lentic-that config))))
         (<span style="color: #00ffff;">let</span> ((updates
                (<span style="color: #00ffff;">or</span>
                 (lentic-update-contents config
                                         start stop length-before)
                 '(nil nil nil))))
           (apply 'lentic-after-change-transform
                  (lentic-that config)
                  updates)
           (lentic-after-change-function-1
            (lentic-that config)
            (nth 0 updates)
            (nth 1 updates)
            (nth 2 updates)
            seen-buffer))))
     lentic-config)))
</pre>
</div>

<p>
We also need to store the location of the area to be changed before the change
happens. Further, we need to convert this at this time to the cognate
positions in the lentic buffers. This is because it is only before the change
that this-buffer and the lentic buffers are in a consistent state; after the
change, this-buffer will have changes not percolated to other buffers. By
making this conversion now, we can ease the implementation of the
`lentic-convert' function because it does not have to cope with buffers with
inconsistent content.
</p>


<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-before-change-function</span> (start stop)
  <span style="color: #ffa07a;">"Error protected call to real `</span><span style="color: #7fffd4;">before-change-function</span><span style="color: #ffa07a;">'.</span>
<span style="color: #ffa07a;">START is at most the start of the change.</span>
<span style="color: #ffa07a;">STOP is at least the end of the change."</span>
  (<span style="color: #00ffff;">unless</span> (<span style="color: #00ffff;">and</span>
           lentic-emergency
           (not lentic-emergency-debug))
    (<span style="color: #00ffff;">lentic-condition-case-unless-disabled</span> err
        (lentic-before-change-function-1 (current-buffer) start stop)
      (<span style="color: #ffc0cb; font-weight: bold;">error</span>
       (lentic-hook-fail err <span style="color: #ffa07a;">"before change"</span>)))))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-before-change-function-1</span> (buffer start stop <span style="color: #98fb98;">&amp;optional</span> seen-buffer)
  <span style="color: #ffa07a;">"Calculate change position in all lentic buffers.</span>
<span style="color: #ffa07a;">BUFFER is the buffer being changed.</span>
<span style="color: #ffa07a;">START is at most the start of the change.</span>
<span style="color: #ffa07a;">STOP is at least the end of the change.</span>
<span style="color: #ffa07a;">SEEN-BUFFER is a list of buffers to which the change has been percolated."</span>
  (<span style="color: #00ffff;">lentic-with-lentic-buffer</span> buffer
    (<span style="color: #00ffff;">setq</span> seen-buffer (cons buffer seen-buffer))
    (<span style="color: #00ffff;">-map</span>
     (<span style="color: #00ffff;">lambda</span> (config)
       (<span style="color: #00ffff;">unless</span>
           (<span style="color: #00ffff;">or</span> (<span style="color: #00ffff;">-contains?</span> seen-buffer (lentic-that config))
               <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">convert uses that buffer</span>
               (not (buffer-live-p (lentic-that config))))
         (<span style="color: #00ffff;">lentic-widen</span>
             config
           (<span style="color: #00ffff;">oset</span> config <span style="color: #b0c4de;">:last-change-start</span> start)
           (<span style="color: #00ffff;">oset</span> config
                 <span style="color: #b0c4de;">:last-change-start-converted</span>
                 (lentic-convert
                  config
                  start))
           (<span style="color: #00ffff;">oset</span> config <span style="color: #b0c4de;">:last-change-stop</span> stop)
           (<span style="color: #00ffff;">oset</span> config
                 <span style="color: #b0c4de;">:last-change-stop-converted</span>
                 (lentic-convert
                  config
                  stop))
           (lentic-before-change-function-1
            (lentic-that config)
            (<span style="color: #00ffff;">oref</span> config <span style="color: #b0c4de;">:last-change-start-converted</span>)
            (<span style="color: #00ffff;">oref</span> config <span style="color: #b0c4de;">:last-change-stop-converted</span>)
            seen-buffer))))
     lentic-config)))
</pre>
</div>

<p>
The `lentic-update-contents' actually transfers changes from one buffer to all
the lentics. Unfortunately before-change-function and after-change-function
are not always consistent with each other. So far the main culprit I have
found is `subst-char-in-region', which is used under the hood of
`fill-paragraph'. On the b-c-f this reports the real start of the change and
the <b>maximal</b> end, while on the a-c-f it reports both the real start and real
end. Unfortunately, we did our conversion to the cognate positions in the
b-c-f <b>and</b> we need these values.
</p>

<p>
The overestimate give inconsistency between the length before on a-c-f (which
is the actual length) and the difference between b-c-f start and stop (which
is the maximal change). Unfortunately, this can also occur in some correct
circumstances &#x2013; replace-match for example can both insert and change
simultaneously.
</p>

<p>
So, the only solution that I have is to use a heuristic to detect <i>skew</i> &#x2013;
when I think the b-c-f and a-c-f are inconsistent, and if it finds it, then
use a full clone (i.e. the whole buffer is dirty).
</p>

<p>
I need to do a full survey of all the functions that call b-c-f/a-c-f (there
are not that many of them!) and rewrite them to all do-the-right thing. Need
to learn C first!
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-update-contents</span> (conf <span style="color: #98fb98;">&amp;optional</span> start stop length-before)
  <span style="color: #ffa07a;">"Update the contents of that-buffer with the contents of this-buffer.</span>
<span style="color: #ffa07a;">update mechanism depends on CONF.</span>
<span style="color: #ffa07a;">START is at most the start of the change.</span>
<span style="color: #ffa07a;">STOP is at least the end of the change.</span>
<span style="color: #ffa07a;">LENGTH-BEFORE is the length of area before the change."</span>
  (<span style="color: #00ffff;">let</span> ((inhibit-read-only t))
    (<span style="color: #00ffff;">let</span> ((skewed
           (<span style="color: #00ffff;">when</span>
               (<span style="color: #00ffff;">or</span>
                <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">previously this was not skewed if no region, but actually,</span>
                <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">if there is no region we need to copy everything, we can</span>
                <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">also do by declaring skew -- this is important for the</span>
                <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">multi-lentic situation</span>
                (not (<span style="color: #00ffff;">or</span> start stop length-before))
                <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">skews only occur in insertions which result in a positive</span>
                <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">length-before. This also picks up no-insertion changes</span>
                (<span style="color: #00ffff;">and</span> (&lt; 0 length-before)
                     <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">= start stop means we have a deletion because</span>
                     <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">there is no range after. Deletions seem to be</span>
                     <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">safe.</span>
                     (not (= start stop))))
             (<span style="color: #00ffff;">lentic-log</span> <span style="color: #ffa07a;">"Skew detected: %s"</span> this-command)
             t)))
      (<span style="color: #00ffff;">m-buffer-with-markers</span>
          ((start-converted
            (<span style="color: #00ffff;">when</span>
                (<span style="color: #00ffff;">and</span> (not skewed)
                     (<span style="color: #00ffff;">oref</span> conf <span style="color: #b0c4de;">:last-change-start-converted</span>))
              (set-marker (make-marker)
                          (<span style="color: #00ffff;">oref</span> conf <span style="color: #b0c4de;">:last-change-start-converted</span>)
                          (lentic-that conf))))
           (stop-converted
            (<span style="color: #00ffff;">when</span>
                (<span style="color: #00ffff;">and</span> (not skewed)
                     (<span style="color: #00ffff;">oref</span> conf <span style="color: #b0c4de;">:last-change-stop-converted</span>))
              (set-marker (make-marker)
                          (<span style="color: #00ffff;">oref</span> conf <span style="color: #b0c4de;">:last-change-stop-converted</span>)
                          (lentic-that conf)))))
        <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">used these, so dump them</span>
        (<span style="color: #00ffff;">oset</span> conf <span style="color: #b0c4de;">:last-change-start</span> nil)
        (<span style="color: #00ffff;">oset</span> conf <span style="color: #b0c4de;">:last-change-start-converted</span> nil)
        (<span style="color: #00ffff;">oset</span> conf <span style="color: #b0c4de;">:last-change-stop</span> nil)
        (<span style="color: #00ffff;">oset</span> conf <span style="color: #b0c4de;">:last-change-stop-converted</span> nil)
        (<span style="color: #00ffff;">lentic-widen</span>
            conf
          (<span style="color: #00ffff;">if</span> skewed
              (lentic-clone conf)
            (lentic-clone conf start stop length-before
                          start-converted stop-converted)))))))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-update-point</span> (conf)
  <span style="color: #ffa07a;">"Update the location of point in that-buffer to reflect this-buffer.</span>
<span style="color: #ffa07a;">This also attempts to update any windows so that they show the</span>
<span style="color: #ffa07a;">same top-left location. Update details depend on CONF."</span>
  <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">only sync when we are told to!</span>
  (<span style="color: #00ffff;">when</span> (<span style="color: #00ffff;">oref</span> conf <span style="color: #b0c4de;">:sync-point</span>)
    (<span style="color: #00ffff;">let*</span> ((from-point
            (lentic-convert
             conf
             (m-buffer-at-point
              (lentic-this conf))))
           (from-window-start
            (lentic-convert
             conf
             (window-start
              (get-buffer-window
               (lentic-this conf))))))
      <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">clone point in buffer important when the buffer is NOT visible in a</span>
      <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">window at all</span>
      <span style="color: #ff7f24;">;;</span><span style="color: #ff7f24;">(lentic-log "sync(front-point)(%s)" from-point)</span>
      (<span style="color: #00ffff;">with-current-buffer</span>
          (lentic-that conf)
        (goto-char from-point))
      <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">now clone point in all the windows that are showing the buffer</span>
      <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">and set the start of the window which is a reasonable attempt to show</span>
      <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">the same thing.</span>
      (mapc
       (<span style="color: #00ffff;">lambda</span> (window)
         (<span style="color: #00ffff;">with-selected-window</span> window
           (<span style="color: #00ffff;">progn</span>
             (goto-char from-point)
             (set-window-start window from-window-start))))
       (get-buffer-window-list (lentic-that conf))))))
</pre>
</div>

<p>
Ugly, ugly, ugly. Not happy with mode-line behaviour anyway, so this will
probably change into the future.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp"><span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">put this here so we don't have to require lentic-mode to ensure that the</span>
<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">mode line is updated.</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-update-display</span> ()
  <span style="color: #ffa07a;">"Update the display with information about lentic's state."</span>
  (<span style="color: #00ffff;">when</span> (fboundp 'lentic-mode-update-mode-line)
    (lentic-mode-update-mode-line)))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-update-all-display</span> ()
  (<span style="color: #00ffff;">when</span> (fboundp 'lentic-mode-update-all-display)
    (lentic-mode-update-all-display)))
</pre>
</div>
</div>
</li></ol>
</li>


<li><a id="sec-3-5-4-4" name="sec-3-5-4-4"></a>Utility<br  /><div class="outline-text-5" id="text-3-5-4-4">
<p>
Just a couple of convenience functions for operating on eieio objects. The
native `oset' only allows setting a single property-value pair which is
irritating syntactically, and it does not return the object which prevents
function chaining. Taken together, these really simplify construction of
objects.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-m-oset</span> (obj <span style="color: #98fb98;">&amp;rest</span> plist)
  <span style="color: #ffa07a;">"On OBJ set all properties in PLIST.</span>
<span style="color: #ffa07a;">Returns OBJ. See also `</span><span style="color: #7fffd4;">lentic-a-oset</span><span style="color: #ffa07a;">'"</span>
  (lentic-a-oset obj plist))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-a-oset</span> (obj plist)
  <span style="color: #ffa07a;">"On OBJ, set all properties in PLIST.</span>
<span style="color: #ffa07a;">This is a utility function which just does the same as oset, but</span>
<span style="color: #ffa07a;">for lots of things at once. Returns OBJ."</span>
  (<span style="color: #00ffff;">-map</span>
   (<span style="color: #00ffff;">lambda</span> (n)
     (eieio-oset
      obj
      (car n)
      (cadr n)))
   (<span style="color: #00ffff;">-partition</span> 2 plist))
  obj)
</pre>
</div>
</div>
</li></ol>
</div>

<div id="outline-container-sec-3-5-5" class="outline-4">
<h4 id="sec-3-5-5"><span class="section-number-4">3.5.5</span> Batch Functions</h4>
<div class="outline-text-4" id="text-3-5-5">
<p>
These functions are for batch operation on lentic buffers. Mostly, these
are useful for writing tests, but they can be useful for generating
the lentic form of a file during any automated pipeline.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-batch-clone-and-save-with-config</span> (filename init)
  <span style="color: #ffa07a;">"Open FILENAME, set INIT function, then clone and save.</span>

<span style="color: #ffa07a;">This function does potentially evil things if the file or the</span>
<span style="color: #ffa07a;">lentic is open already."</span>
  (<span style="color: #00ffff;">let</span> ((retn))
    (<span style="color: #00ffff;">with-current-buffer</span>
        (find-file-noselect filename)
      (<span style="color: #00ffff;">setq</span> lentic-init init)
      (<span style="color: #00ffff;">with-current-buffer</span>
          (car
           (lentic-init-all-create))
        (<span style="color: #00ffff;">setq</span> retn lentic-config)
        (save-buffer)
        (kill-buffer))
      (kill-buffer))
    retn))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-batch-clone-with-config</span>
  (filename init)
  <span style="color: #ffa07a;">"Open FILENAME, set INIT function, then clone.</span>

<span style="color: #ffa07a;">Return the lentic contents without properties."</span>
  (<span style="color: #00ffff;">let</span> ((retn nil))
    (<span style="color: #00ffff;">with-current-buffer</span>
        (find-file-noselect filename)
      (<span style="color: #00ffff;">setq</span> lentic-init init)
      (<span style="color: #00ffff;">with-current-buffer</span>
          (car
           (lentic-init-all-create))
        (<span style="color: #00ffff;">setq</span> retn
              (buffer-substring-no-properties
               (point-min)
               (point-max)))
        (set-buffer-modified-p nil)
        <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">don't delete -- we haven't saved but there</span>
        <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">might already be a file with the same name,</span>
        <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">which will get deleted</span>
        (<span style="color: #00ffff;">oset</span> (car lentic-config) <span style="color: #b0c4de;">:delete-on-exit</span> nil)
        (kill-buffer))
      (set-buffer-modified-p nil)
      (kill-buffer))
    retn))

(<span style="color: #00ffff;">provide</span> '<span style="color: #7fffd4;">lentic</span>)

<span style="color: #ff7f24;">;;; </span><span style="color: #ff7f24;">lentic.el ends here</span>
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Lentic Mode</h2>
<div class="outline-text-2" id="text-4">
<p>
lentic-mode.el provides end-user functions for creating and manipulating
lentic buffers.
</p>
</div>

<div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1"><span class="section-number-3">4.1</span> Commentary</h3>
<div class="outline-text-3" id="text-4-1">
<p>
A minor mode for creating and manipulated lentic buffers.
</p>
</div>
</div>

<div id="outline-container-sec-4-2" class="outline-3">
<h3 id="sec-4-2"><span class="section-number-3">4.2</span> Code</h3>
<div class="outline-text-3" id="text-4-2">
</div><div id="outline-container-sec-4-2-1" class="outline-4">
<h4 id="sec-4-2-1"><span class="section-number-4">4.2.1</span> Preliminaries</h4>
<div class="outline-text-4" id="text-4-2-1">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">require</span> '<span style="color: #7fffd4;">lentic</span>)
(<span style="color: #00ffff;">require</span> '<span style="color: #7fffd4;">lentic-doc</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-2-2" class="outline-4">
<h4 id="sec-4-2-2"><span class="section-number-4">4.2.2</span> Utility</h4>
<div class="outline-text-4" id="text-4-2-2">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-mode-lentic-list</span> (buffer)
  <span style="color: #ffa07a;">"Return a list of all lentics for BUFFER.</span>
<span style="color: #ffa07a;">Lentics are listed in an undefined order."</span>
  (lentic-mode--lentic-list-1 buffer nil))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-mode--lentic-list-1</span> (buffer seen-buffer)
  (<span style="color: #00ffff;">let</span> ((buffers))
    (lentic-each
     buffer
     (<span style="color: #00ffff;">lambda</span> (b)
       (<span style="color: #00ffff;">setq</span> buffers (cons b buffers))))
    buffers))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-mode-buffer-list</span> (buffer <span style="color: #98fb98;">&amp;optional</span> frame)
  <span style="color: #ffa07a;">"Returns a list of all lentics for BUFFER.</span>
<span style="color: #ffa07a;">Lentics are listed in the same order as in fundamental</span>
<span style="color: #ffa07a;">`</span><span style="color: #7fffd4;">buffer-list</span><span style="color: #ffa07a;">'. or the frame local if FRAME is specified."</span>
  (<span style="color: #00ffff;">let</span> ((lentic-list
         (lentic-mode-lentic-list buffer)))
    (<span style="color: #00ffff;">-filter</span>
     (<span style="color: #00ffff;">lambda</span> (b)
       (<span style="color: #00ffff;">-contains?</span> lentic-list b))
     (buffer-list frame))))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-mode-find-next-lentic-buffer</span> (buffer <span style="color: #98fb98;">&amp;optional</span> frame)
  (car
   (<span style="color: #00ffff;">--drop-while</span>
    (eq buffer <span style="color: #eedd82;">it</span>)
    (lentic-mode-buffer-list
     buffer (<span style="color: #00ffff;">or</span> frame (selected-frame))))))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-mode-find-next-visible-lentic-buffer</span> (buffer <span style="color: #98fb98;">&amp;optional</span> frame)
  (car
   (<span style="color: #00ffff;">--drop-while</span>
    (<span style="color: #00ffff;">or</span> (eq buffer <span style="color: #eedd82;">it</span>)
        (not (get-buffer-window <span style="color: #eedd82;">it</span> frame)))
    (lentic-mode-buffer-list
     buffer (<span style="color: #00ffff;">or</span> frame (selected-frame))))))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-mode-find-next-non-visible-lentic-buffer</span> (buffer <span style="color: #98fb98;">&amp;optional</span> frame)
  (car
   (<span style="color: #00ffff;">--drop-while</span>
    (<span style="color: #00ffff;">or</span> (eq buffer <span style="color: #eedd82;">it</span>)
        (get-buffer-window <span style="color: #eedd82;">it</span> frame))
    (lentic-mode-buffer-list
     buffer (<span style="color: #00ffff;">or</span> frame (selected-frame))))))
</pre>
</div>
</div>
</div>



<div id="outline-container-sec-4-2-3" class="outline-4">
<h4 id="sec-4-2-3"><span class="section-number-4">4.2.3</span> Window and Buffer Functions</h4>
<div class="outline-text-4" id="text-4-2-3">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-mode-show-buffer-in-window</span> (before-buffer new-buffer)
  (<span style="color: #00ffff;">let*</span> ((buffer-window (get-buffer-window before-buffer))
         (before-window-start
          (window-start buffer-window))
         (before-window-point
          (m-buffer-at-point before-buffer)))
    (set-window-buffer
     buffer-window
     new-buffer)
    (set-window-start
     buffer-window
     before-window-start)
    (goto-char before-window-point)
    (bury-buffer before-buffer)))

<span style="color: #ff7f24;">;;;</span><span style="color: #ff7f24;">###</span><span style="color: #ffc0cb; font-weight: bold;">autoload</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-mode-create-from-init</span> (<span style="color: #98fb98;">&amp;optional</span> force)
  (<span style="color: #00ffff;">interactive</span> <span style="color: #ffa07a;">"P"</span>)
  (lentic-garbage-collect-config)
  (<span style="color: #00ffff;">if</span> (<span style="color: #00ffff;">and</span> lentic-config (not force))
      (message <span style="color: #ffa07a;">"Already initialized. C-u to force."</span>)
    (<span style="color: #00ffff;">let</span> ((before (length lentic-config))
          (all (lentic-init-all-create)))
      (message <span style="color: #ffa07a;">"Created %s buffers"</span>
               (- (length all)
                  before)))))


<span style="color: #ff7f24;">;;;</span><span style="color: #ff7f24;">###</span><span style="color: #ffc0cb; font-weight: bold;">autoload</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-mode-next-lentic-buffer</span> ()
  <span style="color: #ffa07a;">"Move the lentic buffer into the current window, creating if necessary."</span>
  (<span style="color: #00ffff;">interactive</span>)
  (lentic-mode-show-buffer-in-window
   (current-buffer)
   (lentic-mode-find-next-lentic-buffer (current-buffer))))

<span style="color: #ff7f24;">;;;</span><span style="color: #ff7f24;">###</span><span style="color: #ffc0cb; font-weight: bold;">autoload</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-mode-split-window-below</span> ()
  <span style="color: #ffa07a;">"Move lentic buffer to the window below, creating if needed."</span>
  (<span style="color: #00ffff;">interactive</span>)
  (<span style="color: #00ffff;">-when-let</span>
      (next
       (lentic-mode-find-next-non-visible-lentic-buffer
        (current-buffer)))
    (set-window-buffer
     (split-window-below)
     next)
    next))

<span style="color: #ff7f24;">;;;</span><span style="color: #ff7f24;">###</span><span style="color: #ffc0cb; font-weight: bold;">autoload</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-mode-split-window-right</span> ()
  <span style="color: #ffa07a;">"Move lentic buffer to the window right, creating if needed."</span>
  (<span style="color: #00ffff;">interactive</span>)
  (<span style="color: #00ffff;">-when-let</span>
      (next
       (lentic-mode-find-next-non-visible-lentic-buffer
        (current-buffer)))
    (set-window-buffer
     (split-window-right)
     next)
    next))

<span style="color: #ff7f24;">;;;</span><span style="color: #ff7f24;">###</span><span style="color: #ffc0cb; font-weight: bold;">autoload</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-mode-show-all-lentic</span> ()
  (<span style="color: #00ffff;">interactive</span>)
  (delete-other-windows)
  (<span style="color: #00ffff;">while</span>
      (lentic-mode-split-window-below))
  (balance-windows))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-mode-swap-buffer-windows</span> (a b)
  <span style="color: #ffa07a;">"Swaps the window that two buffers are displayed in.</span>
<span style="color: #ffa07a;">A and B are the buffers."</span>
  (<span style="color: #00ffff;">let</span> ((window-a (get-buffer-window a))
        (window-b (get-buffer-window b)))
    (<span style="color: #00ffff;">when</span> window-a
      (set-window-buffer
       window-a b))
    (<span style="color: #00ffff;">when</span> window-b
      (set-window-buffer
       window-b a))))

<span style="color: #ff7f24;">;;;</span><span style="color: #ff7f24;">###</span><span style="color: #ffc0cb; font-weight: bold;">autoload</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-mode-move-lentic-window</span> ()
  <span style="color: #ffa07a;">"Move the next lentic buffer into the current window.</span>
<span style="color: #ffa07a;">If the lentic is currently being displayed in another window,</span>
<span style="color: #ffa07a;">then the current-buffer will be moved into that window. See also</span>
<span style="color: #ffa07a;">`</span><span style="color: #7fffd4;">lentic-mode-swap-buffer-windows</span><span style="color: #ffa07a;">' and `</span><span style="color: #7fffd4;">lentic-mode-next-buffer</span><span style="color: #ffa07a;">'."</span>
  (<span style="color: #00ffff;">interactive</span>)
  (<span style="color: #00ffff;">let</span> ((before-window-start
         (window-start (get-buffer-window)))
        (before-window-point
         (point)))
    (lentic-mode-swap-buffer-windows
     (current-buffer)
     (<span style="color: #00ffff;">or</span>
      (lentic-mode-find-next-visible-lentic-buffer
       (current-buffer))
      (lentic-mode-find-next-lentic-buffer
       (current-buffer))))
    (set-window-start
     (selected-window)
     before-window-start)
    (goto-char before-window-point)))

<span style="color: #ff7f24;">;;;</span><span style="color: #ff7f24;">###</span><span style="color: #ffc0cb; font-weight: bold;">autoload</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-mode-swap-lentic-window</span> ()
  <span style="color: #ffa07a;">"Swap the window of the buffer and lentic.</span>
<span style="color: #ffa07a;">If both are current displayed, swap the windows they</span>
<span style="color: #ffa07a;">are displayed in, which keeping current buffer.</span>
<span style="color: #ffa07a;">See also `</span><span style="color: #7fffd4;">lentic-mode-move-lentic-window</span><span style="color: #ffa07a;">'."</span>
  (<span style="color: #00ffff;">interactive</span>)
  (lentic-mode-swap-buffer-windows
   (current-buffer)
   (lentic-mode-find-next-visible-lentic-buffer
    (current-buffer)))
  (<span style="color: #00ffff;">when</span> (window-live-p
         (get-buffer-window
          (current-buffer)))
    (select-window
     (get-buffer-window
      (current-buffer)))))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-mode-create-new-view</span> ()
  (<span style="color: #00ffff;">let*</span> ((conf (lentic-default-init))
         (_ (<span style="color: #00ffff;">oset</span> conf
                  <span style="color: #b0c4de;">:sync-point</span> nil))
         (that (lentic-create conf)))
    (<span style="color: #00ffff;">setq</span> lentic-config
          (cons conf lentic-config))
    that))

<span style="color: #ff7f24;">;;;</span><span style="color: #ff7f24;">###</span><span style="color: #ffc0cb; font-weight: bold;">autoload</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-mode-create-new-view-in-selected-window</span> ()
  (<span style="color: #00ffff;">interactive</span>)
  (set-window-buffer
   (selected-window)
   (lentic-mode-create-new-view)))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-mode-force-clone-1</span> ()
  (<span style="color: #00ffff;">lentic-when-lentic</span>
   (<span style="color: #00ffff;">let</span> ((inhibit-modification-hooks t))
     (lentic-after-change-function
      (point-min) (point-max)
      (- (point-max) (point-min))))))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-mode-force-clone</span> ()
  (<span style="color: #00ffff;">interactive</span>)
  (<span style="color: #00ffff;">when</span> (yes-or-no-p <span style="color: #ffa07a;">"Force Clone of the current buffer? "</span>)
    (lentic-mode-force-clone-1)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-2-4" class="outline-4">
<h4 id="sec-4-2-4"><span class="section-number-4">4.2.4</span> Minor Mode</h4>
<div class="outline-text-4" id="text-4-2-4">
<div class="org-src-container">

<pre class="src src-emacs-lisp"><span style="color: #ff7f24;">;;;</span><span style="color: #ff7f24;">###</span><span style="color: #ffc0cb; font-weight: bold;">autoload</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-mode-toggle-auto-sync-point</span> ()
  (<span style="color: #00ffff;">interactive</span>)
  (<span style="color: #00ffff;">lentic-when-lentic</span>
   (<span style="color: #00ffff;">oset</span> lentic-config <span style="color: #b0c4de;">:sync-point</span>
         (not (<span style="color: #00ffff;">oref</span> lentic-config <span style="color: #b0c4de;">:sync-point</span>)))))

(<span style="color: #00ffff;">defvar</span> <span style="color: #eedd82;">lentic-mode-map</span> (make-sparse-keymap)
  <span style="color: #ffa07a;">"Keymap for lentic-minor-mode"</span>)

(define-key lentic-mode-map
  (kbd <span style="color: #ffa07a;">"C-c ,c"</span>) 'lentic-mode-create-from-init)

(define-key lentic-mode-map
  (kbd <span style="color: #ffa07a;">"C-c ,v"</span>) 'lentic-mode-create-new-view-in-selected-window)

(define-key lentic-mode-map
  (kbd <span style="color: #ffa07a;">"C-c ,n"</span>) 'lentic-mode-next-lentic-buffer)

(define-key lentic-mode-map
  (kbd <span style="color: #ffa07a;">"C-c ,s"</span>) 'lentic-mode-swap-lentic-window)

(define-key lentic-mode-map
  (kbd <span style="color: #ffa07a;">"C-c ,h"</span>) 'lentic-mode-move-lentic-window)

(define-key lentic-mode-map
  (kbd <span style="color: #ffa07a;">"C-c ,b"</span>) 'lentic-mode-split-window-below)

(define-key lentic-mode-map
  (kbd <span style="color: #ffa07a;">"C-c ,t"</span>) 'lentic-mode-split-window-right)

(define-key lentic-mode-map
  (kbd <span style="color: #ffa07a;">"C-c ,f"</span>) 'lentic-mode-insert-file-local)

(define-key lentic-mode-map
  (kbd <span style="color: #ffa07a;">"C-c ,a"</span>) 'lentic-mode-show-all-lentic)


(<span style="color: #00ffff;">defcustom</span> <span style="color: #eedd82;">lentic-mode-line-lighter</span> <span style="color: #ffa07a;">"Lentic"</span>
  <span style="color: #ffa07a;">"Default mode lighter for lentic"</span>
  <span style="color: #b0c4de;">:group</span> 'lentic
  <span style="color: #b0c4de;">:type</span> 'string)

(<span style="color: #00ffff;">defvar-local</span> <span style="color: #eedd82;">lentic-mode-line</span> (format <span style="color: #ffa07a;">" %s[]"</span> lentic-mode-line-lighter))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-mode-update-mode-line</span> ()
  (<span style="color: #00ffff;">setq</span> lentic-mode-line
        (format <span style="color: #ffa07a;">" %s[%s]"</span>
                lentic-mode-line-lighter
                (<span style="color: #00ffff;">if</span> lentic-config
                    (s-join <span style="color: #ffa07a;">","</span>
                     (<span style="color: #00ffff;">-map</span>
                      (<span style="color: #00ffff;">lambda</span> (conf)
                        (lentic-mode-line-string conf))
                      lentic-config))
                  <span style="color: #ffa07a;">""</span>))))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-mode-update-all-display</span> ()
  (<span style="color: #00ffff;">if</span> lentic-emergency
      (<span style="color: #00ffff;">setq</span> lentic-mode-line
            (format <span style="color: #ffa07a;">" %s[Emergency]"</span> lentic-mode-line-lighter))
    (<span style="color: #00ffff;">-map</span>
     (<span style="color: #00ffff;">lambda</span> (b)
       (<span style="color: #00ffff;">lentic-when-with-current-buffer</span>
           b
         (lentic-mode-update-mode-line)))
     (buffer-list))
    (force-mode-line-update t)))

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">** lentic self-doc</span>

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">#+begin_src: emacs-lisp</span>
<span style="color: #ff7f24;">;;;</span><span style="color: #ff7f24;">###</span><span style="color: #ffc0cb; font-weight: bold;">autoload</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-mode-doc-eww-view</span> ()
  (<span style="color: #00ffff;">interactive</span>)
  (lentic-doc-eww-view 'lentic))

<span style="color: #ff7f24;">;;;</span><span style="color: #ff7f24;">###</span><span style="color: #ffc0cb; font-weight: bold;">autoload</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-mode-doc-external-view</span> ()
  (<span style="color: #00ffff;">interactive</span>)
  (lentic-doc-external-view 'lentic))

<span style="color: #ff7f24;">;;;</span><span style="color: #ff7f24;">###</span><span style="color: #ffc0cb; font-weight: bold;">autoload</span>
(<span style="color: #00ffff;">define-minor-mode</span> <span style="color: #87cefa;">lentic-mode</span>
  <span style="color: #ffa07a;">"Documentation"</span>
  <span style="color: #b0c4de;">:lighter</span> lentic-mode-line
  <span style="color: #b0c4de;">:keymap</span> lentic-mode-map)

<span style="color: #ff7f24;">;;;</span><span style="color: #ff7f24;">###</span><span style="color: #ffc0cb; font-weight: bold;">autoload</span>
(easy-menu-change
 '(<span style="color: #ffa07a;">"Edit"</span>)
 <span style="color: #ffa07a;">"Lentic"</span>
 '([<span style="color: #ffa07a;">"Create All"</span> lentic-mode-create-from-init
    <span style="color: #b0c4de;">:active</span> (not lentic-config)]
   [<span style="color: #ffa07a;">"Create View"</span> lentic-mode-create-new-view-in-selected-window]
   [<span style="color: #ffa07a;">"Next"</span> lentic-mode-next-lentic-buffer
    <span style="color: #b0c4de;">:active</span> lentic-config]
   [<span style="color: #ffa07a;">"Split Below"</span> lentic-mode-split-window-below
    <span style="color: #b0c4de;">:active</span> lentic-config]
   [<span style="color: #ffa07a;">"Split Right"</span> lentic-mode-split-window-right
    <span style="color: #b0c4de;">:active</span> lentic-config]
   [<span style="color: #ffa07a;">"Show All"</span> lentic-mode-show-all-lentic
    <span style="color: #b0c4de;">:active</span> lentic-config]
   [<span style="color: #ffa07a;">"Swap"</span> lentic-mode-swap-lentic-window
    <span style="color: #b0c4de;">:active</span> lentic-config]
   [<span style="color: #ffa07a;">"Force Clone"</span> lentic-mode-force-clone
    <span style="color: #b0c4de;">:active</span> lentic-config]
   [<span style="color: #ffa07a;">"Insert File Local"</span> lentic-mode-insert-file-local]
   [<span style="color: #ffa07a;">"Read Doc (eww)"</span> lentic-mode-doc-eww-view]
   [<span style="color: #ffa07a;">"Read Doc (external)"</span> lentic-mode-doc-external-view]
   ))

<span style="color: #ff7f24;">;;;</span><span style="color: #ff7f24;">###</span><span style="color: #ffc0cb; font-weight: bold;">autoload</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-mode-insert-file-local</span> (init-function)
  (<span style="color: #00ffff;">interactive</span>
   (list (completing-read
          <span style="color: #ffa07a;">"Lentic init function: "</span>
          (mapcar
           'symbol-name
           lentic-init-functions)
          'identity 'confirm)))
  (add-file-local-variable 'lentic-init (intern init-function)))

<span style="color: #ff7f24;">;;;</span><span style="color: #ff7f24;">###</span><span style="color: #ffc0cb; font-weight: bold;">autoload</span>
(<span style="color: #00ffff;">define-globalized-minor-mode</span> <span style="color: #87cefa;">global-lentic-mode</span>
  lentic-mode
  lentic-mode-on)

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-mode-on</span> ()
  (lentic-mode 1))
</pre>
</div>

<p>
(provide 'lentic-mode)
</p>

<p>
;;; lentic-mode.el ends here
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> Lentic Rot13</h2>
<div class="outline-text-2" id="text-5">
<p>
lentic-rot13.el is entirely useless for practical purposes but demonstrates
how new lenticular transformations can be configured.
</p>
</div>

<div id="outline-container-sec-5-1" class="outline-3">
<h3 id="sec-5-1"><span class="section-number-3">5.1</span> Commentary</h3>
<div class="outline-text-3" id="text-5-1">
<p>
At some point in your life you may find yourself thinking, what would the
text that I am writing now look like in rot13? Of course, you could just
convert it, but really is to see the visualisation as you type. That
would be useful!
</p>

<p>
Now you can.
</p>

<p>
Or more seriously, this is meant as a minimal example of how do implement a
new lentic-buffer-configuration.
</p>
</div>
</div>


<div id="outline-container-sec-5-2" class="outline-3">
<h3 id="sec-5-2"><span class="section-number-3">5.2</span> Code</h3>
<div class="outline-text-3" id="text-5-2">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">require</span> '<span style="color: #7fffd4;">lentic</span>)
(<span style="color: #00ffff;">require</span> '<span style="color: #7fffd4;">rot13</span>)
</pre>
</div>

<p>
Lentic uses EIEIO objects to define the transformation between lentic buffers.
In this case, we extend the default configuration class. We need to add
nothing to the base class or constructor; all changes happen with the generic
methods.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">defclass</span> <span style="color: #98fb98;">lentic-rot13-configuration</span> (lentic-default-configuration) ())
</pre>
</div>

<p>
The clone method defines how to keep the buffers in sync. We defer most of the
work to the superclass method, and then simply rot13 the region that has
changed.
</p>

<p>
The semantics of the parameters are a little complex. The <code>start</code> and <code>stop</code>
parameters define the region in <code>this</code> buffer that has been changed, while
<code>start-converted</code> and <code>stop-converted</code> define the equivalent region <b>before</b>
the change in <code>that</code> buffer.
</p>

<p>
In this example, we are making implicit use of the fact that we can convert
directly between a location in the two buffers. In future versions of
<code>lentic-clone</code> will probably return the changed region directly.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">defmethod</span> <span style="color: #87cefa;">lentic-clone</span> ((conf lentic-rot13-configuration)
                         <span style="color: #98fb98;">&amp;optional</span> start stop _length-before
                         start-converted stop-converted)
  (call-next-method conf start stop _length-before
                    start-converted stop-converted)
  <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">and rot13 it!</span>
  (<span style="color: #00ffff;">with-current-buffer</span>
      (lentic-that conf)
    (<span style="color: #00ffff;">save-restriction</span>
      (rot13-region
       (<span style="color: #00ffff;">or</span> start (point-min))
       (<span style="color: #00ffff;">or</span> stop (point-max))))))
</pre>
</div>

<p>
Lentic buffers have a bi-directional link between them. So, while <i>this</i>
buffer may create <i>that</i> buffer, after the initial creation, the two are
equivalent lenticular views of each other. In terms of lentic, therefore, at
creation time, we need to be able to <i>invert</i> the configuration of <i>this</i>
buffer to create a configuration for <i>that</i> buffer which defines the
transformation from <i>that</i> to <i>this</i>.
</p>

<p>
In this case, the rot13 transformation is symmetrical, so the conversion from
<i>that</i> to <i>this</i> uses an object of the same class as from <i>this</i> to <i>that</i>.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">defmethod</span> <span style="color: #87cefa;">lentic-invert</span> ((conf lentic-rot13-configuration))
  (lentic-rot13-configuration
   <span style="color: #ffa07a;">"rot13-config"</span>
   <span style="color: #b0c4de;">:this-buffer</span> (lentic-that conf)
   <span style="color: #b0c4de;">:that-buffer</span> (lentic-this conf)))
</pre>
</div>

<p>
And, finally, we need to create a function which will construct a new object.
This has to be no-args because it is added as a symbol to `lentic-config'. It
is this function which creates the configuration for initial buffer.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-rot13-init</span> ()
  (lentic-rot13-configuration
   <span style="color: #ffa07a;">"rot13"</span>
   <span style="color: #b0c4de;">:this-buffer</span> (current-buffer)))

(<span style="color: #00ffff;">provide</span> '<span style="color: #7fffd4;">lentic-rot13</span>)
<span style="color: #ff7f24;">;;; </span><span style="color: #ff7f24;">lentic-rot13.el ends here</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> Lentic Chunk</h2>
<div class="outline-text-2" id="text-6">
<p>
Lentic Block provides configurations where blocks of the buffer are
commented in one buffer and not in the others. There are quite a few
extensions of this configuration, including the one that is used to
document this file.
</p>
</div>

<div id="outline-container-sec-6-1" class="outline-3">
<h3 id="sec-6-1"><span class="section-number-3">6.1</span> Commentary</h3>
<div class="outline-text-3" id="text-6-1">
<p>
Lentic-chunk provides support for editing lentic buffers where there are large
documentation chunks in one view which must be commented out in the other,
where the chunks are demarked with some kind of delimitor.
</p>

<p>
This form is generally useful for forms of literate programming. For example,
we might embed Emacs-Lisp within LaTeX like so:
</p>

<pre class="example">
\begin{code}
(message "hello")
\end{code}
</pre>

<p>
In this case, the <code>\begin{code}</code> macro defines the start of the code chunk. In
the code-centric view any lines not enclosed by the markers will be
commented-out, ensure that the documentation does not interfere with whatever
programming language is being used.
</p>

<p>
The implementation provided here is reasonably efficient, with only small
change regions being percolated.
</p>

<p>
This package does not provide any direct end-user configurations. These are
provided elsewhere.
</p>
</div>
</div>

<div id="outline-container-sec-6-2" class="outline-3">
<h3 id="sec-6-2"><span class="section-number-3">6.2</span> Code</h3>
<div class="outline-text-3" id="text-6-2">
<p>
The implementation
</p>
</div>

<div id="outline-container-sec-6-2-1" class="outline-4">
<h4 id="sec-6-2-1"><span class="section-number-4">6.2.1</span> Chunk Configuration</h4>
<div class="outline-text-4" id="text-6-2-1">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">require</span> '<span style="color: #7fffd4;">m-buffer</span>)
(<span style="color: #00ffff;">require</span> '<span style="color: #7fffd4;">m-buffer-at</span>)
(<span style="color: #00ffff;">require</span> '<span style="color: #7fffd4;">lentic</span>)

(<span style="color: #00ffff;">defclass</span> <span style="color: #98fb98;">lentic-chunk-configuration</span> (lentic-default-configuration)
  ((comment <span style="color: #b0c4de;">:initarg</span> <span style="color: #b0c4de;">:comment</span>
            <span style="color: #b0c4de;">:documentation</span> <span style="color: #ffa07a;">"The comment character"</span>)
   (comment-start <span style="color: #b0c4de;">:initarg</span> <span style="color: #b0c4de;">:comment-start</span>
                  <span style="color: #b0c4de;">:documentation</span>
                  <span style="color: #ffa07a;">"Demarcation for the start of the commenting region"</span>)
   (comment-stop <span style="color: #b0c4de;">:initarg</span> <span style="color: #b0c4de;">:comment-stop</span>
                 <span style="color: #b0c4de;">:documentation</span>
                <span style="color: #ffa07a;">"Demarcaction for the end of the commenting region."</span>)
   (case-fold-search <span style="color: #b0c4de;">:initarg</span> <span style="color: #b0c4de;">:case-fold-search</span>
                     <span style="color: #b0c4de;">:documentation</span>
                     <span style="color: #ffa07a;">"Should match be case sensitive"</span>
                     <span style="color: #b0c4de;">:initform</span> <span style="color: #b0c4de;">:default</span>)
   (valid <span style="color: #b0c4de;">:initarg</span> <span style="color: #b0c4de;">:valid</span>
          <span style="color: #b0c4de;">:documentation</span> <span style="color: #ffa07a;">"True if markers in the buffer are valid"</span>
          <span style="color: #b0c4de;">:initform</span> t))
  <span style="color: #b0c4de;">:documentation</span> <span style="color: #ffa07a;">"Base configuration for chunked lentics.</span>
<span style="color: #ffa07a;">A chunked lentic is one where chunks of the buffer have a</span>
<span style="color: #ffa07a;">start of line chunk comment in one buffer but not the other."</span>
  <span style="color: #b0c4de;">:abstract</span> t)

(<span style="color: #00ffff;">defmethod</span> <span style="color: #87cefa;">lentic-mode-line-string</span> ((conf lentic-chunk-configuration))
  (<span style="color: #00ffff;">if</span> (not
       (<span style="color: #00ffff;">oref</span> conf <span style="color: #b0c4de;">:valid</span>))
      <span style="color: #ffa07a;">"invalid"</span>
    (call-next-method conf)))

(<span style="color: #00ffff;">defmethod</span> <span style="color: #87cefa;">lentic-chunk-comment-start-regexp</span>
  ((conf lentic-chunk-configuration))
  <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">todo -- what does this regexp do?</span>
  (format <span style="color: #ffa07a;">"^</span><span style="color: #ffa07a; font-weight: bold;">\\</span><span style="color: #ffa07a; font-weight: bold;">(</span><span style="color: #ffa07a;">%s</span><span style="color: #ffa07a; font-weight: bold;">\\</span><span style="color: #ffa07a; font-weight: bold;">)</span><span style="color: #ffa07a;">?%s"</span>
          (<span style="color: #00ffff;">oref</span> conf <span style="color: #b0c4de;">:comment</span>)
          (<span style="color: #00ffff;">oref</span> conf <span style="color: #b0c4de;">:comment-start</span>)))

(<span style="color: #00ffff;">defmethod</span> <span style="color: #87cefa;">lentic-chunk-comment-stop-regexp</span>
  ((conf lentic-chunk-configuration))
  (format <span style="color: #ffa07a;">"^</span><span style="color: #ffa07a; font-weight: bold;">\\</span><span style="color: #ffa07a; font-weight: bold;">(</span><span style="color: #ffa07a;">%s</span><span style="color: #ffa07a; font-weight: bold;">\\</span><span style="color: #ffa07a; font-weight: bold;">)</span><span style="color: #ffa07a;">?%s"</span>
          (<span style="color: #00ffff;">oref</span> conf <span style="color: #b0c4de;">:comment</span>)
          (<span style="color: #00ffff;">oref</span> conf <span style="color: #b0c4de;">:comment-stop</span>)))

(<span style="color: #00ffff;">defmethod</span> <span style="color: #87cefa;">lentic-chunk-line-start-comment</span>
  ((conf lentic-chunk-configuration))
  (concat <span style="color: #ffa07a;">"^"</span>
          (<span style="color: #00ffff;">oref</span> conf <span style="color: #b0c4de;">:comment</span>)))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-chunk-uncomment-region</span> (conf begin end buffer)
  <span style="color: #ffa07a;">"Given CONF,  remove start-of-line characters in region.</span>
<span style="color: #ffa07a;">Region is between BEGIN and END in BUFFER. CONF is a</span>
<span style="color: #ffa07a;">function `</span><span style="color: #7fffd4;">lentic-configuration</span><span style="color: #ffa07a;">' object."</span>
  <span style="color: #ff7f24;">;;</span><span style="color: #ff7f24;">(lentic-log "uncomment-region (%s,%s)" begin end)</span>
  (<span style="color: #00ffff;">m-buffer-with-markers</span>
      ((comments
        (m-buffer-match
         buffer
         (lentic-chunk-line-start-comment conf)
         <span style="color: #b0c4de;">:begin</span> begin <span style="color: #b0c4de;">:end</span> end)))
    (m-buffer-replace-match comments <span style="color: #ffa07a;">""</span>)))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-chunk-uncomment-buffer</span> (conf markers begin end buffer)
  <span style="color: #ffa07a;">"Given CONF, a `</span><span style="color: #7fffd4;">lentic-configuration</span><span style="color: #ffa07a;">' object, remove all</span>
<span style="color: #ffa07a;">start of line comment-characters in appropriate chunks. Changes</span>
<span style="color: #ffa07a;">should only have occurred between BEGIN and END in BUFFER."</span>
  (<span style="color: #00ffff;">-map</span>
   (<span style="color: #00ffff;">lambda</span> (pairs)
     (<span style="color: #00ffff;">let</span>
         ((chunk-begin (car pairs))
          (chunk-end (cadr pairs)))
       (<span style="color: #00ffff;">when</span>
           (<span style="color: #00ffff;">and</span> (&gt;= end chunk-begin)
                (&gt;= chunk-end begin))
         (lentic-chunk-uncomment-region
          conf chunk-begin chunk-end buffer))))
   markers))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-chunk-comment-region</span> (conf begin end buffer)
  <span style="color: #ffa07a;">"Given CONF, a `</span><span style="color: #7fffd4;">lentic-configuration</span><span style="color: #ffa07a;">' object, add</span>
<span style="color: #ffa07a;">start of line comment characters beween BEGIN and END in BUFFER."</span>
  (<span style="color: #00ffff;">m-buffer-with-markers</span>
      ((line-match
        (m-buffer-match
         buffer
         <span style="color: #ffa07a;">"</span><span style="color: #ffa07a; font-weight: bold;">\\</span><span style="color: #ffa07a; font-weight: bold;">(</span><span style="color: #ffa07a;">^</span><span style="color: #ffa07a; font-weight: bold;">\\</span><span style="color: #ffa07a; font-weight: bold;">)</span><span style="color: #ffa07a;">.+$"</span>
         <span style="color: #b0c4de;">:begin</span> begin <span style="color: #b0c4de;">:end</span> end))
       (comment-match
        (m-buffer-match
         buffer
         <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">start to end of line which is what this regexp above matches</span>
         (concat
          (lentic-chunk-line-start-comment conf)
          <span style="color: #ffa07a;">".*"</span>)
         <span style="color: #b0c4de;">:begin</span> begin <span style="color: #b0c4de;">:end</span> end)))
    (m-buffer-replace-match
     (m-buffer-match-exact-subtract line-match comment-match)
     (<span style="color: #00ffff;">oref</span> conf <span style="color: #b0c4de;">:comment</span>) nil nil 1)))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-chunk-comment-buffer</span> (conf markers begin end buffer)
  <span style="color: #ffa07a;">"Given CONF, a `</span><span style="color: #7fffd4;">lentic-configuration</span><span style="color: #ffa07a;">' object, add</span>
<span style="color: #ffa07a;">start of line comment-characters. Changes should only have occurred</span>
<span style="color: #ffa07a;">between BEGIN and END in BUFFER."</span>
  <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">we need these as markers because the begin and end position need to</span>
  <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">move as we change the buffer, in the same way that the marker boundary</span>
  <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">markers do.</span>
  (<span style="color: #00ffff;">m-buffer-with-markers</span>
      ((begin (set-marker (make-marker) begin buffer))
       (end (set-marker (make-marker) end buffer)))
    (<span style="color: #00ffff;">-map</span>
     <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">comment each of these regions</span>
     (<span style="color: #00ffff;">lambda</span> (pairs)
       (<span style="color: #00ffff;">let</span>
           ((chunk-begin (car pairs))
            (chunk-end (cadr pairs)))
         (<span style="color: #00ffff;">when</span>
             (<span style="color: #00ffff;">and</span> (&gt;= end chunk-begin)
                  (&gt;= chunk-end begin))
           (lentic-chunk-comment-region
            conf chunk-begin chunk-end buffer))))
     markers)))

(<span style="color: #00ffff;">defmethod</span> <span style="color: #87cefa;">lentic-chunk-marker-boundaries</span> ((conf lentic-chunk-configuration)
                                         buffer)
  <span style="color: #ffa07a;">"Given CONF, a `</span><span style="color: #7fffd4;">lentic-configuration</span><span style="color: #ffa07a;">' object, find</span>
<span style="color: #ffa07a;">demarcation markers. Returns a list of start end cons pairs.</span>
<span style="color: #ffa07a;">`</span><span style="color: #7fffd4;">point-min</span><span style="color: #ffa07a;">' is considered to be an implicit start and `</span><span style="color: #7fffd4;">point-max</span><span style="color: #ffa07a;">'</span>
<span style="color: #ffa07a;">an implicit stop."</span>
  (<span style="color: #00ffff;">let*</span> ((match-chunk
          (lentic-chunk-match
           conf buffer))
         (match-start
          (car match-chunk))
         (match-end
          (cadr match-chunk)))
    (<span style="color: #00ffff;">if</span>
        (= (length match-start)
           (length match-end))
        (<span style="color: #00ffff;">progn</span>
          (<span style="color: #00ffff;">unless</span>
              (<span style="color: #00ffff;">oref</span> conf <span style="color: #b0c4de;">:valid</span>)
            (<span style="color: #00ffff;">oset</span> conf <span style="color: #b0c4de;">:valid</span> t)
            (lentic-update-display))
          (<span style="color: #00ffff;">with-current-buffer</span> buffer
            (<span style="color: #00ffff;">-zip-with</span>
             #'list
             <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">start comment markers</span>
             <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">plus the start of the region</span>
             (cons
              (set-marker (make-marker) (point-min) buffer)
              match-start)
             <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">end comment markers</span>
             <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">plus the end of the buffer</span>
             (append
              match-end
              (list (set-marker (make-marker) (point-max) buffer))))))
      <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">delimiters do not match so return error value</span>
      (<span style="color: #00ffff;">lentic-log</span> <span style="color: #ffa07a;">"delimiters do not match"</span>)
      (<span style="color: #00ffff;">when</span> (<span style="color: #00ffff;">oref</span> conf <span style="color: #b0c4de;">:valid</span>)
        (<span style="color: #00ffff;">oset</span> conf <span style="color: #b0c4de;">:valid</span> nil)
        (lentic-update-display))
      <span style="color: #b0c4de;">:unmatched</span>)))

(<span style="color: #00ffff;">defmethod</span> <span style="color: #87cefa;">lentic-chunk-match</span> ((conf lentic-chunk-configuration)
                                      buffer)
  (list
   (m-buffer-match-begin
    buffer
    (lentic-chunk-comment-start-regexp conf)
    <span style="color: #b0c4de;">:case-fold-search</span> (<span style="color: #00ffff;">oref</span> conf <span style="color: #b0c4de;">:case-fold-search</span>))
   (m-buffer-match-end
    buffer
    (lentic-chunk-comment-stop-regexp conf)
    <span style="color: #b0c4de;">:case-fold-search</span> (<span style="color: #00ffff;">oref</span> conf <span style="color: #b0c4de;">:case-fold-search</span>))))

(<span style="color: #00ffff;">defmethod</span> <span style="color: #87cefa;">lentic-convert</span> ((conf lentic-chunk-configuration)
                                  location)
  <span style="color: #ffa07a;">"Converts a LOCATION in buffer FROM into one from TO.</span>
<span style="color: #ffa07a;">This uses a simple algorithm; we pick the same line and then</span>
<span style="color: #ffa07a;">count from the end, until we get to location, always staying on</span>
<span style="color: #ffa07a;">the same line. This works since the buffers are identical except</span>
<span style="color: #ffa07a;">for changes to the beginning of the line. It is also symmetrical</span>
<span style="color: #ffa07a;">between the two buffers; we don't care which one has comments."</span>
  <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">current information comes inside a with-current-buffer. so, we capture</span>
  <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">data as a list rather than having two with-current-buffers.</span>
  (<span style="color: #00ffff;">let</span> ((line-plus
         (<span style="color: #00ffff;">with-current-buffer</span>
             (lentic-this conf)
           (<span style="color: #00ffff;">save-excursion</span>
             <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">move to location or line-end-position may be wrong</span>
             (goto-char location)
             (list
              <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">we are converting the location, so we need the line-number</span>
              (line-number-at-pos location)
              <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">and the distance from the end</span>
              (- (line-end-position)
                 location))))))
    (<span style="color: #00ffff;">with-current-buffer</span>
        (lentic-that conf)
      (<span style="color: #00ffff;">save-excursion</span>
        (goto-char (point-min))
        <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">move forward to the line in question</span>
        (forward-line (1- (car line-plus)))
        <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">don't move from the line in question</span>
        (max (line-beginning-position)
             <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">but move in from the end</span>
             (- (line-end-position)
                (cadr line-plus)))))))


(<span style="color: #00ffff;">defclass</span> <span style="color: #98fb98;">lentic-commented-chunk-configuration</span>
  (lentic-chunk-configuration)
  ()
  <span style="color: #ffa07a;">"Configuration for chunked lentic with comments."</span>)

(<span style="color: #00ffff;">defclass</span> <span style="color: #98fb98;">lentic-uncommented-chunk-configuration</span>
  (lentic-chunk-configuration)
  ()
  <span style="color: #ffa07a;">"Configuration for chunked lentic without comments."</span>)

(<span style="color: #00ffff;">defmethod</span> <span style="color: #87cefa;">lentic-clone</span>
  ((conf lentic-commented-chunk-configuration)
   <span style="color: #98fb98;">&amp;optional</span> start stop length-before start-converted stop-converted)
  <span style="color: #ffa07a;">"Update the contents in the lentic without comments"</span>
  <span style="color: #ff7f24;">;;</span><span style="color: #ff7f24;">(lentic-log "chunk-clone-uncomment (from):(%s)" conf)</span>
  (<span style="color: #00ffff;">let*</span>
      <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">we need to detect whether start or stop are in the comment region at</span>
      <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">the beginning of the file. We check this by looking at :that-buffer</span>
      <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">-- if we are in the magic region, then we must be at the start of</span>
      <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">line. In this case, we copy the entire line as it is in a hard to</span>
      <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">predict state. This is slightly over cautious (it also catches first</span>
      <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">character), but this is safe, it only causes the occasional</span>
      <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">unnecessary whole line copy. In normal typing "whole line" will be</span>
      <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">one character anyway</span>
      ((start-in-comment
        (<span style="color: #00ffff;">when</span>
            (<span style="color: #00ffff;">and</span> start
                 (m-buffer-at-bolp
                  (lentic-that conf)
                  start-converted))
          (m-buffer-at-line-beginning-position
           (lentic-this conf)
           start)))
       (start (<span style="color: #00ffff;">or</span> start-in-comment start))
       (start-converted
        (<span style="color: #00ffff;">if</span> start-in-comment
          (m-buffer-at-line-beginning-position
           (lentic-that conf)
           start-converted)
          start-converted))
       <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">likewise for stop</span>
       (stop-in-comment
        (<span style="color: #00ffff;">when</span>
            (<span style="color: #00ffff;">and</span> stop
                 (m-buffer-at-bolp
                  (lentic-that conf)
                  stop-converted))
          (m-buffer-at-line-end-position
              (lentic-this conf)
              stop)))
       (stop (<span style="color: #00ffff;">or</span> stop-in-comment stop))
       (stop-converted
        (<span style="color: #00ffff;">if</span> stop-in-comment
            (m-buffer-at-line-end-position
                (lentic-that conf)
                stop-converted)
          stop-converted)))
    <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">log when we have gone long</span>
    (<span style="color: #00ffff;">if</span> (<span style="color: #00ffff;">or</span> start-in-comment stop-in-comment)
        (<span style="color: #00ffff;">lentic-log</span> <span style="color: #ffa07a;">"In comment: %s %s"</span>
                           (<span style="color: #00ffff;">when</span> start-in-comment
                             <span style="color: #ffa07a;">"start"</span>)
                           (<span style="color: #00ffff;">when</span> stop-in-comment
                             <span style="color: #ffa07a;">"stop"</span>)))
    <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">now clone the buffer, recording the return value unless either the</span>
    <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">start or the stop is in comment, in which case we need a nil.</span>
    (<span style="color: #00ffff;">let*</span> ((clone-return
            (call-next-method conf start stop length-before
                              start-converted stop-converted))
           (clone-return
            (<span style="color: #00ffff;">unless</span> (<span style="color: #00ffff;">or</span> start-in-comment stop-in-comment)
              clone-return))
           <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">record the validity of the buffer as it was</span>
           (validity (<span style="color: #00ffff;">oref</span> conf <span style="color: #b0c4de;">:valid</span>))
           (markers
            (lentic-chunk-marker-boundaries
             conf
             (lentic-that conf))))
      (<span style="color: #00ffff;">cond</span>
          <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">we are unmatched, but we used to be valid, which means that we</span>
          <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">have just become invalid, so we want to do a full clone</span>
          <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">straight-away to make sure that both buffers are now identical</span>
          ((<span style="color: #00ffff;">and</span>
            (equal <span style="color: #b0c4de;">:unmatched</span>
                   markers)
            validity)
           (call-next-method conf))
          <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">we are unmatched, and we were unmatched before. We have already</span>
          <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">done the incremental clone, so stop.</span>
          ((equal <span style="color: #b0c4de;">:unmatched</span> markers)
           nil)
          <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">we have matched delimiters but we were not matched before. This</span>
          <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">means we will have done an identity clone which means that other</span>
          <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">buffer will be all commented up. So remove all comments and clean</span>
          <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">up all the markers</span>
          ((not validity)
           (<span style="color: #00ffff;">m-buffer-with-markers</span>
               ((markers markers))
             (lentic-chunk-uncomment-buffer
              conf
              markers
              (lentic-convert conf (point-min))
              (lentic-convert conf (point-max))
              (lentic-that conf))
             ))
          (t
           <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">just uncomment the bit we have cloned.</span>
           (lentic-chunk-uncomment-buffer
            conf
            markers
            <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">the buffer at this point has been copied over, but is in an</span>
            <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">inconsistent state (because it may have comments that it should</span>
            <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">not). Still, the convertor should still work because it counts fr</span><span style="color: #ee82ee; background-color: #333333;">om</span>
            <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">the end</span>
            (lentic-convert
             conf
             <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">point-min if we know nothing else</span>
             (<span style="color: #00ffff;">or</span> start (point-min)))
            (lentic-convert
             conf
             <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">if we have a stop</span>
             (<span style="color: #00ffff;">if</span> stop
                 <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">take stop (if we have got longer) or</span>
                 <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">start length before (if we have got shorter)</span>
                 (max stop
                      (+ start length-before))
               (point-max)))
            (lentic-that conf))))
      clone-return)))

(<span style="color: #00ffff;">defmethod</span> <span style="color: #87cefa;">lentic-invert</span>
  ((conf lentic-commented-chunk-configuration))
  (lentic-uncommented-chunk-configuration
   <span style="color: #ffa07a;">"commented-inverted"</span>
   <span style="color: #b0c4de;">:this-buffer</span> (lentic-that conf)
   <span style="color: #b0c4de;">:that-buffer</span> (lentic-this conf)
   <span style="color: #b0c4de;">:comment</span> (<span style="color: #00ffff;">oref</span> conf <span style="color: #b0c4de;">:comment</span>)
   <span style="color: #b0c4de;">:comment-start</span> (<span style="color: #00ffff;">oref</span> conf <span style="color: #b0c4de;">:comment-start</span>)
   <span style="color: #b0c4de;">:comment-stop</span> (<span style="color: #00ffff;">oref</span> conf <span style="color: #b0c4de;">:comment-stop</span>)))

(<span style="color: #00ffff;">defmethod</span> <span style="color: #87cefa;">lentic-clone</span>
  ((conf lentic-uncommented-chunk-configuration)
   <span style="color: #98fb98;">&amp;optional</span> start stop length-before start-converted stop-converted)
  <span style="color: #ffa07a;">"Update the contents in the lentic without comments."</span>
  <span style="color: #ff7f24;">;;</span><span style="color: #ff7f24;">(lentic-log "chunk-clone-comment conf):(%s)" conf)</span>
  (<span style="color: #00ffff;">let*</span>
      ((start-at-bolp
        (<span style="color: #00ffff;">when</span>
            (<span style="color: #00ffff;">and</span> start
                 (m-buffer-at-bolp
                  (lentic-this conf)
                  start))
          (m-buffer-at-line-beginning-position
              (lentic-that conf)
              start-converted)))
       (start-converted (<span style="color: #00ffff;">or</span> start-at-bolp start-converted)))
    (<span style="color: #00ffff;">if</span> (<span style="color: #00ffff;">or</span> start-at-bolp)
        (<span style="color: #00ffff;">lentic-log</span> <span style="color: #ffa07a;">"In comment: %s"</span>
                           (<span style="color: #00ffff;">when</span> start-at-bolp
                             <span style="color: #ffa07a;">"start"</span>)))
    (<span style="color: #00ffff;">let*</span> ((clone-return
            (call-next-method conf start stop length-before
                              start-converted stop-converted))
           (clone-return
            (<span style="color: #00ffff;">unless</span> start-at-bolp
              clone-return))
           (validity (<span style="color: #00ffff;">oref</span> conf <span style="color: #b0c4de;">:valid</span>))
           (markers
            (lentic-chunk-marker-boundaries
             conf
             (lentic-that conf))))
      (<span style="color: #00ffff;">cond</span>
       ((<span style="color: #00ffff;">and</span> (equal <span style="color: #b0c4de;">:unmatched</span> markers)
             validity)
        (call-next-method conf))

       ((equal <span style="color: #b0c4de;">:unmatched</span> markers)
        nil)

       ((not validity)
        (<span style="color: #00ffff;">m-buffer-with-markers</span>
            ((markers markers))
          (lentic-chunk-comment-buffer
           conf
           markers
           (lentic-convert conf (point-min))
           (lentic-convert conf (point-max))
           (lentic-that conf))))

       (t
        (lentic-chunk-comment-buffer
         conf
         markers
         <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">the buffer at this point has been copied over, but is in an</span>
         <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">inconsistent state (because it may have comments that it should</span>
         <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">not). Still, the convertor should still work because it counts from</span>
         <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">the end</span>
         (lentic-convert
          conf
          <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">point-min if we know nothing else</span>
          (<span style="color: #00ffff;">or</span> start (point-min)))
         (lentic-convert
          conf
          <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">if we have a stop</span>
          (<span style="color: #00ffff;">if</span> stop
              <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">take stop (if we have got longer) or</span>
              <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">start length before (if we have got shorter)</span>
              (max stop
                   (+ start length-before))
            (point-max)))
         (lentic-that conf))))
      clone-return)))

(<span style="color: #00ffff;">defmethod</span> <span style="color: #87cefa;">lentic-invert</span>
  ((conf lentic-uncommented-chunk-configuration))
  (lentic-commented-chunk-configuration
   <span style="color: #ffa07a;">"uncommented-inverted"</span>
   <span style="color: #b0c4de;">:this-buffer</span> (lentic-that conf)
   <span style="color: #b0c4de;">:that-buffer</span> (lentic-this conf)
   <span style="color: #b0c4de;">:comment</span> (<span style="color: #00ffff;">oref</span> conf <span style="color: #b0c4de;">:comment</span>)
   <span style="color: #b0c4de;">:comment-start</span> (<span style="color: #00ffff;">oref</span>  conf <span style="color: #b0c4de;">:comment-start</span>)
   <span style="color: #b0c4de;">:comment-stop</span> (<span style="color: #00ffff;">oref</span> conf <span style="color: #b0c4de;">:comment-stop</span>)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-6-2-2" class="outline-4">
<h4 id="sec-6-2-2"><span class="section-number-4">6.2.2</span> Unmatched Chunk Configuration</h4>
<div class="outline-text-4" id="text-6-2-2">
<p>
Unmatched chunks are those when the number of "start" delimitors and "end"
delimitors are not the same. The motivating example here was org-mode where
the <code>begin_src</code> tags name the language but the <code>end_src</code> do not. Hence, one
org file with two languages break lentic.
</p>

<p>
The solution is to search for the start tags and then take just the next stop
tag, a solution we already use for asciidoc. The disadvantage is that the
buffer can no longer become invalid which is useful for detecting accidentally
mis-matched tags.
</p>

<p>
The implementation is provided by the `lentic-unmatched-chunk-configuration'
class, which is then mixed-in with the two subclasses.
</p>


<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">defclass</span> <span style="color: #98fb98;">lentic-unmatched-chunk-configuration</span> ()
  ()
  <span style="color: #b0c4de;">:documentation</span> <span style="color: #ffa07a;">"Configuration for chunked lentics where the</span>
<span style="color: #ffa07a;">markers are not necessarily paired. Instead for every open chunk</span>
<span style="color: #ffa07a;">marker, the next close marker is used, and all others are</span>
<span style="color: #ffa07a;">ignored."</span>
  <span style="color: #b0c4de;">:abstract</span> t)

(<span style="color: #00ffff;">defmethod</span> <span style="color: #87cefa;">lentic-chunk-marker-boundaries</span>
  ((conf lentic-unmatched-chunk-configuration)
   buffer)
  <span style="color: #ffa07a;">"Given CONF, a `</span><span style="color: #7fffd4;">lentic-configuration</span><span style="color: #ffa07a;">' object, find</span>
<span style="color: #ffa07a;">demarcation markers. Returns a list of start end cons pairs.</span>
<span style="color: #ffa07a;">`</span><span style="color: #7fffd4;">point-min</span><span style="color: #ffa07a;">' is considered to be an implicit start and `</span><span style="color: #7fffd4;">point-max</span><span style="color: #ffa07a;">'</span>
<span style="color: #ffa07a;">an implicit stop."</span>
  (<span style="color: #00ffff;">let*</span> ((match-chunk
          (lentic-chunk-match
           conf buffer))
         (match-start
          (car match-chunk))
         (match-end
          (cadr match-chunk)))
    (<span style="color: #00ffff;">let*</span> ((part
            (<span style="color: #00ffff;">-drop-while</span>
             (<span style="color: #00ffff;">lambda</span> (n)
               (not (car n)))
             (m-buffer-partition-by-marker
              match-start match-end)))
           (zipped
            (<span style="color: #00ffff;">with-current-buffer</span> buffer
              (<span style="color: #00ffff;">-zip-with</span>
               #'list
               (cons (point-min-marker)
                     (<span style="color: #00ffff;">-map</span> #'cadr part))
               (<span style="color: #00ffff;">-snoc</span>
                (<span style="color: #00ffff;">-map</span> #'car part)
                (point-max-marker))))))
      zipped)))

(<span style="color: #00ffff;">defclass</span> <span style="color: #98fb98;">lentic-unmatched-commented-chunk-configuration</span>
  (lentic-unmatched-chunk-configuration
   lentic-commented-chunk-configuration)
  ())

(<span style="color: #00ffff;">defmethod</span> <span style="color: #87cefa;">lentic-invert</span>
  ((conf lentic-unmatched-commented-chunk-configuration))
  (lentic-unmatched-uncommented-chunk-configuration
   <span style="color: #ffa07a;">"unmatched-commented-inverted"</span>
   <span style="color: #b0c4de;">:this-buffer</span> (lentic-that conf)
   <span style="color: #b0c4de;">:that-buffer</span> (lentic-this conf)
   <span style="color: #b0c4de;">:comment</span> (<span style="color: #00ffff;">oref</span> conf <span style="color: #b0c4de;">:comment</span>)
   <span style="color: #b0c4de;">:comment-start</span> (<span style="color: #00ffff;">oref</span> conf <span style="color: #b0c4de;">:comment-start</span>)
   <span style="color: #b0c4de;">:comment-stop</span> (<span style="color: #00ffff;">oref</span> conf <span style="color: #b0c4de;">:comment-stop</span>)))


(<span style="color: #00ffff;">defclass</span> <span style="color: #98fb98;">lentic-unmatched-uncommented-chunk-configuration</span>
  (lentic-unmatched-chunk-configuration
   lentic-uncommented-chunk-configuration)
  ())

(<span style="color: #00ffff;">defmethod</span> <span style="color: #87cefa;">lentic-invert</span>
  ((conf lentic-unmatched-uncommented-chunk-configuration))
  (lentic-unmatched-commented-chunk-configuration
   <span style="color: #ffa07a;">"unmatched-uncommented-inverted"</span>
   <span style="color: #b0c4de;">:this-buffer</span> (lentic-that conf)
   <span style="color: #b0c4de;">:that-buffer</span> (lentic-this conf)
   <span style="color: #b0c4de;">:comment</span> (<span style="color: #00ffff;">oref</span> conf <span style="color: #b0c4de;">:comment</span>)
   <span style="color: #b0c4de;">:comment-start</span> (<span style="color: #00ffff;">oref</span> conf <span style="color: #b0c4de;">:comment-start</span>)
   <span style="color: #b0c4de;">:comment-stop</span> (<span style="color: #00ffff;">oref</span> conf <span style="color: #b0c4de;">:comment-stop</span>)))

(<span style="color: #00ffff;">provide</span> '<span style="color: #7fffd4;">lentic-chunk</span>)

<span style="color: #ff7f24;">;;; </span><span style="color: #ff7f24;">lentic-chunk.el ends here</span>
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7"><span class="section-number-2">7</span> Lentic Asciidoc</h2>
<div class="outline-text-2" id="text-7">
<p>
A lentic block configuration for use with asciidoc.
</p>
</div>

<div id="outline-container-sec-7-1" class="outline-3">
<h3 id="sec-7-1"><span class="section-number-3">7.1</span> Commentary</h3>
<div class="outline-text-3" id="text-7-1">
<p>
Lentic buffers with asciidoc [source] blocks.
</p>
</div>
</div>

<div id="outline-container-sec-7-2" class="outline-3">
<h3 id="sec-7-2"><span class="section-number-3">7.2</span> Code</h3>
<div class="outline-text-3" id="text-7-2">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">require</span> '<span style="color: #7fffd4;">lentic</span>)
(<span style="color: #00ffff;">require</span> '<span style="color: #7fffd4;">lentic-chunk</span>)
(<span style="color: #00ffff;">require</span> '<span style="color: #7fffd4;">m-buffer</span>)
(<span style="color: #00ffff;">require</span> '<span style="color: #7fffd4;">f</span>)

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-asciidoc-oset</span> (conf)
  (lentic-m-oset
   conf
   <span style="color: #b0c4de;">:this-buffer</span> (current-buffer)
   <span style="color: #b0c4de;">:comment</span> <span style="color: #ffa07a;">";; "</span>))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-asciidoc-commented-new</span> ()
  (lentic-asciidoc-oset
   (lentic-commented-asciidoc-configuration
    <span style="color: #ffa07a;">"lb-commented-clojure asciidoc"</span>
    <span style="color: #b0c4de;">:lentic-file</span>
    (concat
     (file-name-sans-extension
      (buffer-file-name)) <span style="color: #ffa07a;">".adoc"</span>))))

<span style="color: #ff7f24;">;;;</span><span style="color: #ff7f24;">###</span><span style="color: #ffc0cb; font-weight: bold;">autoload</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-clojure-asciidoc-init</span> ()
  (lentic-asciidoc-commented-new))

(add-to-list 'lentic-init-functions
             'lentic-clojure-asciidoc-init)

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-asciidoc-uncommented-new</span> ()
  (lentic-asciidoc-oset
   (lentic-uncommented-asciidoc-configuration
    <span style="color: #ffa07a;">"lb-uncommented-clojure-asciidoc"</span>
    <span style="color: #b0c4de;">:lentic-file</span>
    (concat
     (file-name-sans-extension
      (buffer-file-name)) <span style="color: #ffa07a;">".clj"</span>))))

<span style="color: #ff7f24;">;;;</span><span style="color: #ff7f24;">###</span><span style="color: #ffc0cb; font-weight: bold;">autoload</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-asciidoc-clojure-init</span> ()
  (lentic-asciidoc-uncommented-new))

<span style="color: #ff7f24;">;;;</span><span style="color: #ff7f24;">###</span><span style="color: #ffc0cb; font-weight: bold;">autoload</span>
(add-to-list 'lentic-init-functions
             'lentic-asciidoc-clojure-init)


<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">** Support Emacs-Lisp</span>
<span style="color: #ff7f24;">;;;</span><span style="color: #ff7f24;">###</span><span style="color: #ffc0cb; font-weight: bold;">autoload</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-asciidoc-el-init</span> ()
  (lentic-asciidoc-oset
   (lentic-uncommented-asciidoc-configuration
    <span style="color: #ffa07a;">"temp"</span>
    <span style="color: #b0c4de;">:lentic-file</span>
    (concat
     (file-name-sans-extension
      (buffer-file-name)) <span style="color: #ffa07a;">".el"</span>))))

<span style="color: #ff7f24;">;;;</span><span style="color: #ff7f24;">###</span><span style="color: #ffc0cb; font-weight: bold;">autoload</span>
(add-to-list 'lentic-init-functions
             'lentic-asciidoc-el-init)


(<span style="color: #00ffff;">defclass</span> <span style="color: #98fb98;">lentic-commented-asciidoc-configuration</span>
  (lentic-commented-chunk-configuration)
  ((srctags <span style="color: #b0c4de;">:initarg</span> <span style="color: #b0c4de;">:srctags</span>
            <span style="color: #b0c4de;">:documentation</span> <span style="color: #ffa07a;">"Language tags in source chunk"</span>
            <span style="color: #b0c4de;">:initform</span> '(<span style="color: #ffa07a;">"clojure"</span> <span style="color: #ffa07a;">"lisp"</span>)))
  <span style="color: #ffa07a;">"Lentic buffer config for asciidoc and other code."</span>)

(<span style="color: #00ffff;">defclass</span> <span style="color: #98fb98;">lentic-uncommented-asciidoc-configuration</span>
  (lentic-uncommented-chunk-configuration)
  ((srctags <span style="color: #b0c4de;">:initarg</span> <span style="color: #b0c4de;">:srctags</span>
            <span style="color: #b0c4de;">:documentation</span> <span style="color: #ffa07a;">"Language tags in source chunk"</span>
            <span style="color: #b0c4de;">:initform</span> '(<span style="color: #ffa07a;">"clojure"</span> <span style="color: #ffa07a;">"lisp"</span>)))
  <span style="color: #ffa07a;">"Lentic buffer config for asciidoc and other code"</span>)


(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-splitter</span> (l)
  <span style="color: #ffa07a;">"Returns a function which for use as a partition predicate.</span>
<span style="color: #ffa07a;">The returned function returns the first element of L until it is</span>
<span style="color: #ffa07a;">passed a value higher than the first element, then it returns the</span>
<span style="color: #ffa07a;">second element and so on."</span>
  #'(lambda (x)
      (<span style="color: #00ffff;">when</span>
          (<span style="color: #00ffff;">and</span> l
               (&lt; (car l) x))
        (<span style="color: #00ffff;">setq</span> l (<span style="color: #00ffff;">-drop</span> 1 l)))
      (car l)))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-partition-after-source</span> (l-source l-dots)
  <span style="color: #ffa07a;">"Given a set of markers l-source, partition the markers in</span>
<span style="color: #ffa07a;">l-dots.</span>

<span style="color: #ffa07a;">The source markers represent [source] markers, so we take the</span>
<span style="color: #ffa07a;">next matches to \"....\" immediately after a [source] marker.</span>
<span style="color: #ffa07a;">This should remove other \"....\" matches.</span>
<span style="color: #ffa07a;">"</span>
  (<span style="color: #00ffff;">-partition-by</span>
   (lentic-splitter l-source)
   (<span style="color: #00ffff;">-drop-while</span>
    (<span style="color: #00ffff;">lambda</span> (x)
      (<span style="color: #00ffff;">and</span> l-source
           (&lt; x (car l-source))))
    l-dots)))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-chunk-match-asciidoc</span>
  (conf buffer)
  (<span style="color: #00ffff;">let*</span> ((source
          (m-buffer-match-begin
           buffer
           (format <span style="color: #ffa07a;">";* *\\[source,%s\\]"</span>
                   (regexp-opt
                    (<span style="color: #00ffff;">oref</span> conf <span style="color: #b0c4de;">:srctags</span>)))))
         <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">this could also be a start of title</span>
         (dots
          (m-buffer-match buffer
                          <span style="color: #ffa07a;">"^;* *----"</span>))
         (source-start
          (lentic-partition-after-source
           source
           (m-buffer-match-begin
            dots)))
         (source-end
          (lentic-partition-after-source
           source (m-buffer-match-end dots))))
    (<span style="color: #00ffff;">when</span> source
      (list
       (<span style="color: #00ffff;">-map</span> 'cadr source-start)
       (<span style="color: #00ffff;">-map</span> 'car source-end)))))

(<span style="color: #00ffff;">defmethod</span> <span style="color: #87cefa;">lentic-chunk-match</span>
  ((conf lentic-commented-asciidoc-configuration) buffer)
  (lentic-chunk-match-asciidoc conf buffer))

(<span style="color: #00ffff;">defmethod</span> <span style="color: #87cefa;">lentic-chunk-match</span>
  ((conf lentic-uncommented-asciidoc-configuration) buffer)
  (lentic-chunk-match-asciidoc conf buffer))

(<span style="color: #00ffff;">defmethod</span> <span style="color: #87cefa;">lentic-invert</span>
  ((conf lentic-commented-asciidoc-configuration))
  (lentic-m-oset (lentic-asciidoc-uncommented-new)
                 <span style="color: #b0c4de;">:that-buffer</span> (lentic-this conf)))

(<span style="color: #00ffff;">defmethod</span> <span style="color: #87cefa;">lentic-invert</span>
  ((conf lentic-uncommented-asciidoc-configuration))
  (lentic-m-oset (lentic-asciidoc-commented-new)
                 <span style="color: #b0c4de;">:that-buffer</span> (lentic-this conf)))

(<span style="color: #00ffff;">provide</span> '<span style="color: #7fffd4;">lentic-asciidoc</span>)
<span style="color: #ff7f24;">;;; </span><span style="color: #ff7f24;">lentic-asciidoc.el ends here</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8"><span class="section-number-2">8</span> Lentic Latex</h2>
<div class="outline-text-2" id="text-8">
<p>
A lentic block configuration for use with latex.
</p>
</div>

<div id="outline-container-sec-8-1" class="outline-3">
<h3 id="sec-8-1"><span class="section-number-3">8.1</span> Commentary</h3>
<div class="outline-text-3" id="text-8-1">
<p>
A `lentic-chunk-configuration' environment where one buffer is latex
and the other is some programming language, with code chunks marked up with
a <code>\begin{code}\end{code}</code> environment.
</p>

<p>
The code environment is not normally defined and has been picked for this
reason. It avoids defining multiple init functions for different macros;
instead the code chunks can be interpreted using what ever environment the
author wants, by defining the code environment first.
</p>
</div>
</div>

<div id="outline-container-sec-8-2" class="outline-3">
<h3 id="sec-8-2"><span class="section-number-3">8.2</span> Code</h3>
<div class="outline-text-3" id="text-8-2">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">require</span> '<span style="color: #7fffd4;">lentic-chunk</span>)

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-latex-clojure-oset</span> (conf)
  (lentic-m-oset
   conf
   <span style="color: #b0c4de;">:this-buffer</span> (current-buffer)
   <span style="color: #b0c4de;">:comment</span> <span style="color: #ffa07a;">";; "</span>
   <span style="color: #b0c4de;">:comment-start</span> <span style="color: #ffa07a;">"\\\\end{code}"</span>
   <span style="color: #b0c4de;">:comment-stop</span> <span style="color: #ffa07a;">"\\\\begin{code}"</span>))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-clojure-to-latex-new</span> ()
  (lentic-latex-clojure-oset
   (lentic-commented-chunk-configuration
    <span style="color: #ffa07a;">"lb-commented clojure latex"</span>
    <span style="color: #b0c4de;">:lentic-file</span>
    (concat
     (file-name-sans-extension
      (buffer-file-name)) <span style="color: #ffa07a;">".tex"</span>))))

<span style="color: #ff7f24;">;;;</span><span style="color: #ff7f24;">###</span><span style="color: #ffc0cb; font-weight: bold;">autoload</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-clojure-latex-init</span> ()
  (lentic-clojure-to-latex-new))

(add-to-list 'lentic-init-functions
             'lentic-clojure-latex-init)


(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-latex-to-clojure-new</span> ()
  (lentic-latex-clojure-oset
   (lentic-uncommented-chunk-configuration
    <span style="color: #ffa07a;">"lb-commented latex clojure"</span>
    <span style="color: #b0c4de;">:lentic-file</span>
    (concat
     (file-name-sans-extension
      (buffer-file-name)) <span style="color: #ffa07a;">".clj"</span>))))

<span style="color: #ff7f24;">;;;</span><span style="color: #ff7f24;">###</span><span style="color: #ffc0cb; font-weight: bold;">autoload</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-latex-clojure-init</span> ()
  (lentic-latex-to-clojure-new))

(add-to-list 'lentic-init-functions
             'lentic-clojure-latex-init)

<span style="color: #ff7f24;">;;;</span><span style="color: #ff7f24;">###</span><span style="color: #ffc0cb; font-weight: bold;">autoload</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-clojure-latex-delayed-init</span> ()
  (lentic-delayed-init 'lentic-clojure-latex-init))

(add-to-list 'lentic-init-functions
             'lentic-clojure-latex-delayed-init)

<span style="color: #ff7f24;">;;;</span><span style="color: #ff7f24;">###</span><span style="color: #ffc0cb; font-weight: bold;">autoload</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-haskell-latex-init</span> ()
  (lentic-default-configuration
   <span style="color: #ffa07a;">"lb-haskell"</span>
   <span style="color: #b0c4de;">:this-buffer</span> (current-buffer)
   <span style="color: #b0c4de;">:lentic-file</span>
   (concat
    (file-name-sans-extension
     (buffer-file-name))
    <span style="color: #ffa07a;">".tex"</span>)))

(add-to-list
 'lentic-init-functions
 'lentic-haskell-latex-init)

(<span style="color: #00ffff;">provide</span> '<span style="color: #7fffd4;">lentic-latex-code</span>)

<span style="color: #ff7f24;">;;; </span><span style="color: #ff7f24;">lentic-latex-code ends here</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-9" class="outline-2">
<h2 id="sec-9"><span class="section-number-2">9</span> Lentic Org</h2>
<div class="outline-text-2" id="text-9">
<p>
A lentic block configuration for use with org. This includes a more
specialised and complex transformation between Emacs-Lisp and Org.
</p>
</div>

<div id="outline-container-sec-9-1" class="outline-3">
<h3 id="sec-9-1"><span class="section-number-3">9.1</span> Commentary</h3>
<div class="outline-text-3" id="text-9-1">
<p>
This file provides lentic for org and emacs-lisp files. This enables a
literate form of programming with Elisp, using org mode to provide
documentation mark up.
</p>

<p>
It provides too main ways of integrating between org and emacs-lisp. The
first which we call org-el (or el-org) is a relatively simple translation
between the two modes.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">require</span> '<span style="color: #7fffd4;">cl-lib</span>)
(<span style="color: #00ffff;">require</span> '<span style="color: #7fffd4;">rx</span>)
(<span style="color: #00ffff;">require</span> '<span style="color: #7fffd4;">lentic-chunk</span>)
(<span style="color: #00ffff;">require</span> '<span style="color: #7fffd4;">m-buffer-at</span>)
</pre>
</div>
</div>
</div>


<div id="outline-container-sec-9-2" class="outline-3">
<h3 id="sec-9-2"><span class="section-number-3">9.2</span> Code</h3>
<div class="outline-text-3" id="text-9-2">
</div><div id="outline-container-sec-9-2-1" class="outline-4">
<h4 id="sec-9-2-1"><span class="section-number-4">9.2.1</span> Simple org-&gt;el</h4>
<div class="outline-text-4" id="text-9-2-1">
<p>
The simple transformation between org and elisp is to just comment out
everything that is not inside a BEGIN<sub>SRC</sub>/END<sub>SRC</sub> chunk. This provides only
minimal advantages over the embedded org mode environment. Org, for instance,
allows native fontification of the embedded code (i.e. elisp will be coloured
like elisp!), which is something that org-el translation also gives for free;
in this case of org-el, however, when the code is high-lighted, the org mode
text is visually reduced to `comment-face'. The other key advantage is
familiarity; it is possible to switch to the `emacs-lisp-mode' buffer and
eval-buffer, region or expression using all the standard keypresses.
</p>

<p>
One problem with this mode is that elisp has a first line semantics for
file-local variables. This is a particular issue if setting `lexical-binding'.
In a literate org file, this might appear on the first line of the
embedded lisp, but it will <b>not</b> appear in first line of an emacs-lisp
lentic, so the file will be interpreted with dynamic binding.
</p>
</div>


<ol class="org-ol"><li><a id="sec-9-2-1-1" name="sec-9-2-1-1"></a>Implementation<br  /><div class="outline-text-5" id="text-9-2-1-1">
<p>
The implementation is a straight-forward use of `lentic-chunk' with
regexps for org source chunks. It currently takes no account of
org-mode :tangle directives &#x2013; so all lisp in the buffer will be present in
the emacs-lisp mode lentic.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-org-oset</span> (conf)
  (lentic-m-oset
   conf
   <span style="color: #b0c4de;">:this-buffer</span> (current-buffer)
   <span style="color: #b0c4de;">:comment</span> <span style="color: #ffa07a;">";; "</span>
   <span style="color: #b0c4de;">:comment-stop</span> <span style="color: #ffa07a;">"#\\\+BEGIN_SRC emacs-lisp.*"</span>
   <span style="color: #b0c4de;">:comment-start</span> <span style="color: #ffa07a;">"#\\\+END_SRC"</span>))

<span style="color: #ff7f24;">;;;</span><span style="color: #ff7f24;">###</span><span style="color: #ffc0cb; font-weight: bold;">autoload</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-org-el-init</span> ()
  (lentic-org-oset
   (lentic-unmatched-uncommented-chunk-configuration
    <span style="color: #ffa07a;">"lb-org-to-el"</span>
    <span style="color: #b0c4de;">:lentic-file</span>
    (concat
     (file-name-sans-extension
      (buffer-file-name))
     <span style="color: #ffa07a;">".el"</span>))))

(add-to-list 'lentic-init-functions
             'lentic-org-el-init)

<span style="color: #ff7f24;">;;;</span><span style="color: #ff7f24;">###</span><span style="color: #ffc0cb; font-weight: bold;">autoload</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-el-org-init</span> ()
  (lentic-org-oset
   (lentic-unmatched-commented-chunk-configuration
    <span style="color: #ffa07a;">"lb-el-to-org"</span>
    <span style="color: #b0c4de;">:lentic-file</span>
    (concat
     (file-name-sans-extension
      (buffer-file-name))
     <span style="color: #ffa07a;">".org"</span>))))

(add-to-list 'lentic-init-functions
             'lentic-el-org-init)
</pre>
</div>
</div>
</li></ol>
</div>


<div id="outline-container-sec-9-2-2" class="outline-4">
<h4 id="sec-9-2-2"><span class="section-number-4">9.2.2</span> orgel-&gt;org</h4>
<div class="outline-text-4" id="text-9-2-2">
<p>
In this section, we define a different transformation from what we call an
orgel file. This is a completely valid emacs-lisp file which transforms
cleanly into a valid org file. This requires constraits on both the emacs-lisp
and org representation. However, most of the features of both modes are
available.
</p>

<p>
The advantages of orgel files over a tangle-able literate org file are
several. The main one, however, is that the <code>.el</code> file remains a source
format. It can be loaded directly by Emacs with `load-library' or `require'.
Developers downloading from a VCS will find the <code>.el</code> file rather than looking
for an <code>.org</code> file. Developers wishing to offer patches can do so to the <code>.el</code>
file. Finally, tools which work over <code>.el</code> such as checkdoc will still work.
Finally, there is no disjoint between the org file and the emacs-lisp
comments. The commentary section, for example, can be edited using `org-mode'
rather than as comments in an elisp code chunk.
</p>

<p>
The disadvantages are that the structure of the org file is not arbitrary; it
most follow a specific structure. Without an untangling process, things like
noweb references will not work.
</p>

<p>
The transformation (orgel -&gt; org) works as follows:
</p>
<ul class="org-ul">
<li>the first line summary is transformed into a comment in org
</li>
<li>all single word ";;;" headers are transformed into level 1 org headings.
</li>
<li>";;" comments are removed except inside emacs-lisp source chunks.
</li>
</ul>
</div>

<ol class="org-ol"><li><a id="sec-9-2-2-1" name="sec-9-2-2-1"></a>Converting an Existing file<br  /><div class="outline-text-5" id="text-9-2-2-1">
<p>
It is relatively simple to convert an existing emacs-lisp file, so that it
will work with the orgel transformation. orgel files work with (nearly) all
existing Emacs-Lisp documentaton standards but have a few extra bits added
in to work with org.
</p>

<p>
Current ";;;" section demarcation headers in emacs-lisp are used directly
and are transformed into Section 1 headings in org-mode. Unfortunately, in
emacs-lisp the header is <b>not</b> explicitly marked &#x2013; it's just the start
to the ";;; Commentary:" header. To enable folding of the header,
therefore, you need to introduce a ";;; Header:" line <b>after</b> the first line.
You may also wish to add a ";;; Footer:" heading as well.
</p>

<p>
Secondly, mark <b>all</b> of the code with org-mode source demarks. Finally, set
`lentic-init' to `lentic-orgel-org-init' (normally with a
file-local or dir-local variable). Now lentic can be started. The
header will appear as normal text in the org-mode buffer, with all other
comments inside a source chunk. You can now move through the buffer splitting
the source chunk (with `org-babel-demarcate-block' which has to win a prize
for the most obscurely named command), and move comments out of the source
chunk into the newly created text chunk.
</p>
</div>
</li>

<li><a id="sec-9-2-2-2" name="sec-9-2-2-2"></a>Limitations<br  /><div class="outline-text-5" id="text-9-2-2-2">
<p>
Currently, the implementation still requires some extra effort from the elisp
side, in that lisp must be marked up as a source code block. The short term
fix would be to add some functionality like `org-babel-demarcate-block' to
emacs-lisp-mode. Even better would to automatically add source markup when "("
was pressed at top level (if paredit were active, then it would also be
obvious where to put the close). Finally, have both `lentic-org' and
`org-mode' just recognise emacs-lisp as a source entity <b>without</b> any further
markup.
</p>

<p>
Finally, I don't like the treatment of the summary line &#x2013; ideally this should
appear somewhere in the org file not as a comment. I am constrained by the
start of file semantics of both <code>.org</code> and <code>.el</code> so this will probably remain.
The content can always be duplicated which is painful, but the summary line is
unlikely to get updated regularly.
</p>
</div>
</li>


<li><a id="sec-9-2-2-3" name="sec-9-2-2-3"></a>Implementation<br  /><div class="outline-text-5" id="text-9-2-2-3">
<p>
The main transformation issue is the first line. An <code>.el</code> file has a summary
at the top. This is checked by checkdoc, used by the various lisp management
tools, which in turn impacts on the packaging tools. Additionally, lexical
binding really must be set here.
</p>

<p>
We solve this problem by transforming the first line ";;;" into "# #". Having
three characters means that the width is maintained. It also means I can
distinguish between this kind of comment and an "ordinary" `org-mode' comment;
in practice, this doesn't matter, because I only check on the first line. The
space is necessary because `org-mode' doesn't recognised "###" as a comment.
</p>

<p>
Another possibility would be to transform the summary line into a header. I
choose against this because first it's not really a header being too long and
second `org-mode' uses the space before the first header to specify, for
example, properties relevant to the entire tree. This is prevented if I make
the first line a header 1.
</p>
</div>

<ol class="org-ol"><li><a id="sec-9-2-2-3-1" name="sec-9-2-2-3-1"></a>org to orgel<br  /><div class="outline-text-6" id="text-9-2-2-3-1">
<p>
Here we define a new class or org-to-orgel, as well as clone function which
adds the ";;;" header transformation in addition to the normal chunk semantics
from the superclass. Currently only single word headers are allowed which
seems consistent with emacs-lisp usage.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">defclass</span> <span style="color: #98fb98;">lentic-org-to-orgel-configuration</span>
  (lentic-unmatched-chunk-configuration lentic-uncommented-chunk-configuration)
  ())


(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-org--first-line-fixup</span> (conf first-line-end)
  <span style="color: #ffa07a;">"Fixup the first line of an org-&gt;orgel file.</span>

<span style="color: #ffa07a;">This swaps lines of form:</span>

<span style="color: #ffa07a;">;; ;;; or</span>
<span style="color: #ffa07a;"># #</span>

<span style="color: #ffa07a;">into</span>

<span style="color: #ffa07a;">;;;"</span>
  (m-buffer-replace-match
   (m-buffer-match
    (lentic-that conf)
    <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">we can be in one of two states depending on whether we have made a new</span>
    <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">clone or an incremental change</span>
    (<span style="color: #00ffff;">rx</span>
     (<span style="color: #00ffff;">and</span> line-start <span style="color: #ffa07a;">";; "</span>
          (submatch (<span style="color: #00ffff;">or</span> <span style="color: #ffa07a;">";;;"</span>
                        <span style="color: #ffa07a;">"# #"</span>))))
    <span style="color: #b0c4de;">:end</span> first-line-end)
   <span style="color: #ffa07a;">";;;"</span>))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-org--h1-fixup-from-start</span> (conf first-line-end)
  <span style="color: #ffa07a;">"Fixup h1 with start</span>

<span style="color: #ffa07a;">This swaps lines of form</span>

<span style="color: #ffa07a;">;; * Header</span>

<span style="color: #ffa07a;">or</span>

<span style="color: #ffa07a;">;; * Header    :tag:</span>

<span style="color: #ffa07a;">into</span>

<span style="color: #ffa07a;">;;; Header:    :tag:"</span>
  (m-buffer-replace-match
           (m-buffer-match
            (lentic-that conf)
            (<span style="color: #00ffff;">rx</span>
             (<span style="color: #00ffff;">and</span> line-start <span style="color: #ffa07a;">";; * "</span>
                  (submatch (1+ word))
                  (optional
                   (submatch
                    (0+ <span style="color: #ffa07a;">" "</span>)
                    <span style="color: #ffa07a;">":"</span> (1+ word) <span style="color: #ffa07a;">":"</span>))))
            <span style="color: #b0c4de;">:begin</span> first-line-end)
           <span style="color: #ffa07a;">";;; \\1:\\2"</span>))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-org--h1-fixup-from-semi</span> (conf first-line-end)
  <span style="color: #ffa07a;">"Fixup h1 with semis"</span>
  (m-buffer-replace-match
   (m-buffer-match
    (lentic-that conf)
    (<span style="color: #00ffff;">rx</span>
     (<span style="color: #00ffff;">and</span> line-start
          <span style="color: #ffa07a;">";; ;;; "</span>
          (submatch (1+ word))
          (optional <span style="color: #ffa07a;">":"</span>)
          (optional
           (submatch
            (0+ <span style="color: #ffa07a;">" "</span>)
            <span style="color: #ffa07a;">":"</span> (1+ word) <span style="color: #ffa07a;">":"</span>))))
    <span style="color: #b0c4de;">:begin</span> first-line-end)
   <span style="color: #ffa07a;">";;; \\1:\\2"</span>))


(<span style="color: #00ffff;">defmethod</span> <span style="color: #87cefa;">lentic-clone</span>
  ((conf lentic-org-to-orgel-configuration)
   <span style="color: #98fb98;">&amp;optional</span> start stop length-before
   start-converted stop-converted)
  <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">do everything else to the buffer</span>
  (<span style="color: #00ffff;">m-buffer-with-markers</span>
      ((first-line
        (m-buffer-match-first-line
         (lentic-this conf)))
       (header-one-line
        (m-buffer-match
         (lentic-this conf)
         (<span style="color: #00ffff;">rx</span> line-start
             <span style="color: #ffa07a;">"* "</span> (0+ word)
             (optional (1+ <span style="color: #ffa07a;">" "</span>)
                       <span style="color: #ffa07a;">":"</span> (1+ word) <span style="color: #ffa07a;">":"</span>)
             line-end)
         <span style="color: #b0c4de;">:begin</span> (cl-cadar first-line)))
       (special-lines
        (<span style="color: #00ffff;">-concat</span> first-line header-one-line)))
    <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">check whether we are in a special line -- if so widen the change extent</span>
    (<span style="color: #00ffff;">let*</span>
        ((start-in-special
          (<span style="color: #00ffff;">when</span>
              (<span style="color: #00ffff;">and</span>
               start
               (m-buffer-in-match-p
                special-lines start))
            (m-buffer-at-line-beginning-position
             (lentic-this conf)
             start)))
         (start (<span style="color: #00ffff;">or</span> start-in-special start))
         (start-converted
          (<span style="color: #00ffff;">if</span> start-in-special
              (m-buffer-at-line-beginning-position
               (lentic-that conf)
               start-converted)
            start-converted))
         (stop-in-special
          (<span style="color: #00ffff;">when</span>
              (<span style="color: #00ffff;">and</span>
               stop
               (m-buffer-in-match-p
                special-lines stop))
            (m-buffer-at-line-end-position
             (lentic-this conf)
             stop)))
         (stop (<span style="color: #00ffff;">or</span> stop-in-special stop))
         (stop-converted
          (<span style="color: #00ffff;">if</span> stop-in-special
              (m-buffer-at-line-end-position
               (lentic-that conf)
               stop-converted)
            stop-converted))
         (clone-return
          (call-next-method conf start stop length-before
                            start-converted stop-converted))
         (first-line-end-match
          (cl-cadar
           (m-buffer-match-first-line
            (lentic-that conf))))
         <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">can't just use or here because we need non-short circuiting</span>
         (c1 (lentic-org--first-line-fixup conf first-line-end-match))
         <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">replace big headers, in either of their two states</span>
         (c2 (lentic-org--h1-fixup-from-start conf first-line-end-match))
         (c3 (lentic-org--h1-fixup-from-semi conf first-line-end-match)))
      (<span style="color: #00ffff;">if</span> (<span style="color: #00ffff;">or</span> start-in-special stop-in-special c1 c2 c3)
          nil
        clone-return))))

(<span style="color: #00ffff;">defmethod</span> <span style="color: #87cefa;">lentic-convert</span>
  ((conf lentic-org-to-orgel-configuration)
   location)
  (<span style="color: #00ffff;">let</span> ((converted (call-next-method conf location)))
    (<span style="color: #00ffff;">m-buffer-with-current-position</span>
        (<span style="color: #00ffff;">oref</span> conf <span style="color: #b0c4de;">:this-buffer</span>)
        location
      (beginning-of-line)
      (<span style="color: #00ffff;">if</span> (looking-at
           (<span style="color: #00ffff;">rx</span> (submatch <span style="color: #ffa07a;">"* "</span>)
               (submatch (1+ word))
               (optional (1+ <span style="color: #ffa07a;">" "</span>)
                         <span style="color: #ffa07a;">":"</span> (1+ word) <span style="color: #ffa07a;">":"</span>)
               line-end))
          (<span style="color: #00ffff;">cond</span>
           ((= location (nth 2 (match-data)))
            (m-buffer-at-line-beginning-position
             (<span style="color: #00ffff;">oref</span> conf <span style="color: #b0c4de;">:that-buffer</span>)
             converted))
           ((&lt; location (nth 5 (match-data)))
            (- converted 1))
           (t
            converted))
        converted))))

(<span style="color: #00ffff;">defmethod</span> <span style="color: #87cefa;">lentic-invert</span>
  ((conf lentic-org-to-orgel-configuration))
  (lentic-m-oset
   (lentic-orgel-org-init)
   <span style="color: #b0c4de;">:that-buffer</span>
   (lentic-this conf)))

<span style="color: #ff7f24;">;;;</span><span style="color: #ff7f24;">###</span><span style="color: #ffc0cb; font-weight: bold;">autoload</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-org-orgel-init</span> ()
  (lentic-org-oset
   (lentic-org-to-orgel-configuration
    <span style="color: #ffa07a;">"lb-orgel-to-el"</span>
    <span style="color: #b0c4de;">:lentic-file</span>
    (concat
     (file-name-sans-extension
      (buffer-file-name))
     <span style="color: #ffa07a;">".el"</span>))))

(add-to-list 'lentic-init-functions
             'lentic-org-orgel-init)
</pre>
</div>
</div>
</li>

<li><a id="sec-9-2-2-3-2" name="sec-9-2-2-3-2"></a>orgel-&gt;org<br  /><div class="outline-text-6" id="text-9-2-2-3-2">
<p>
And the orgel-&gt;org implementation. Currently, this means that I have all the
various regexps in two places which is a bit ugly. I am not sure how to stop
this.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">defvar</span> <span style="color: #eedd82;">lentic-orgel-org-init-hook</span> nil)

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">shut byte compiler up and define var for setq-local</span>
(<span style="color: #00ffff;">defvar</span> <span style="color: #eedd82;">org-archive-default-command</span>)

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-orgel-org-init-default-hook</span> ()
  <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">Better to open all trees in lentic so that both buffers appears the same</span>
  <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">size.</span>
  (show-all)
  <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">Archiving very easy to and almost always a disaster when it removes an</span>
  <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">entire tree from the buffer.</span>
  (<span style="color: #00ffff;">require</span> '<span style="color: #7fffd4;">org-archive</span>)
  (<span style="color: #00ffff;">setq-local</span> org-archive-default-command
              (<span style="color: #00ffff;">let</span> ((old-archive
                     org-archive-default-command))
                (<span style="color: #00ffff;">lambda</span> ()
                  (<span style="color: #00ffff;">interactive</span>)
                  (<span style="color: #00ffff;">if</span> (yes-or-no-p
                       <span style="color: #ffa07a;">"Really archive in lentic mode? "</span>)
                      (funcall old-archive)
                    (message <span style="color: #ffa07a;">"Archiving aborted"</span>))))))

(add-hook 'lentic-orgel-org-init-hook
          #'lentic-orgel-org-init-default-hook)


(<span style="color: #00ffff;">defclass</span> <span style="color: #98fb98;">lentic-orgel-to-org-configuration</span>
  (lentic-unmatched-chunk-configuration lentic-commented-chunk-configuration)
  ())

(<span style="color: #00ffff;">defmethod</span> <span style="color: #87cefa;">lentic-create</span>
  ((conf lentic-orgel-to-org-configuration))
  (<span style="color: #00ffff;">let</span> ((buf
         (call-next-method conf)))
    (<span style="color: #00ffff;">with-current-buffer</span>
        buf
      (run-hooks 'lentic-orgel-org-init-hook))
    buf))

(<span style="color: #00ffff;">defmethod</span> <span style="color: #87cefa;">lentic-clone</span>
  ((conf lentic-orgel-to-org-configuration)
   <span style="color: #98fb98;">&amp;optional</span> start stop length-before start-converted stop-converted)
  <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">do everything else to the buffer</span>
  (<span style="color: #00ffff;">let*</span> ((clone-return
          (call-next-method conf start stop length-before
                            start-converted stop-converted))
         (m1
          (m-buffer-replace-match
           (m-buffer-match
            (lentic-that conf)
            <span style="color: #ffa07a;">";;; "</span>
            <span style="color: #b0c4de;">:end</span>
            (cl-cadar
             (m-buffer-match-first-line
              (lentic-that conf))))
           <span style="color: #ffa07a;">"# # "</span>))
         (m2
          (m-buffer-replace-match
           (m-buffer-match (lentic-that conf)
                           (<span style="color: #00ffff;">rx</span> line-start <span style="color: #ffa07a;">";;; "</span>
                               (submatch (0+ word))
                               <span style="color: #ffa07a;">":"</span>
                               (optional
                                (submatch
                                 (0+ <span style="color: #ffa07a;">" "</span>)
                                 <span style="color: #ffa07a;">":"</span> (1+ word) <span style="color: #ffa07a;">":"</span>))
                               line-end))
           <span style="color: #ffa07a;">"* \\1\\2"</span>)))
    (<span style="color: #00ffff;">unless</span>
        <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">update some stuff</span>
        (<span style="color: #00ffff;">or</span> m1 m2)
      <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">and return clone-return unless we have updated stuff in which case</span>
      <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">return nil</span>
      clone-return)))

(<span style="color: #00ffff;">defmethod</span> <span style="color: #87cefa;">lentic-convert</span>
  ((conf lentic-orgel-to-org-configuration)
   location)
  <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">if we are a header one and we are *after* the first :, then just call</span>
  <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">next-method.</span>
  (<span style="color: #00ffff;">let*</span> ((cnm
         (call-next-method conf location))
        (line-start-that
         (m-buffer-at-line-beginning-position
          (<span style="color: #00ffff;">oref</span> conf <span style="color: #b0c4de;">:that-buffer</span>) cnm))
        (line-start-this
         (m-buffer-at-line-beginning-position
          (<span style="color: #00ffff;">oref</span> conf <span style="color: #b0c4de;">:this-buffer</span>) location)))
    (<span style="color: #00ffff;">if</span>
        (<span style="color: #00ffff;">m-buffer-with-current-position</span>
            (<span style="color: #00ffff;">oref</span> conf <span style="color: #b0c4de;">:this-buffer</span>)
            location
          (beginning-of-line)
          (looking-at
           (<span style="color: #00ffff;">rx</span> <span style="color: #ffa07a;">";;; "</span>
               (1+ word)
               (submatch <span style="color: #ffa07a;">":"</span>)
               (optional (1+ <span style="color: #ffa07a;">" "</span>)
                         <span style="color: #ffa07a;">":"</span> (1+ word) <span style="color: #ffa07a;">":"</span>))))
        <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">hey global state!</span>
        (<span style="color: #00ffff;">let</span> ((colon (nth 3 (match-data))))
          <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">if in the comments, just return the start of the</span>
          <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">line, if we are after the comments but before the colon, fudge</span>
          <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">it. If we are after the colon, count from the end</span>
          (<span style="color: #00ffff;">cond</span>
           ((&gt; 3 (- location line-start-this))
            line-start-that)
           ((&gt; location colon)
            cnm)
           (t
            (+ cnm 1))))
      cnm)))

(<span style="color: #00ffff;">defmethod</span> <span style="color: #87cefa;">lentic-invert</span>
  ((conf lentic-orgel-to-org-configuration))
  (lentic-m-oset
   (lentic-org-orgel-init)
   <span style="color: #b0c4de;">:delete-on-exit</span> t
   <span style="color: #b0c4de;">:that-buffer</span> (lentic-this conf)))

<span style="color: #ff7f24;">;;;</span><span style="color: #ff7f24;">###</span><span style="color: #ffc0cb; font-weight: bold;">autoload</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-orgel-org-init</span> ()
  (lentic-org-oset
   (lentic-orgel-to-org-configuration
    <span style="color: #ffa07a;">"lb-orgel-to-org"</span>
    <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">we don't really need a file and could cope without, but org mode assumes</span>
    <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">that the buffer is file name bound when it exports. As it happens, this</span>
    <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">also means that file saving is possible which in turn saves the el file</span>
    <span style="color: #b0c4de;">:lentic-file</span>
    (concat
     (file-name-sans-extension
      (buffer-file-name))
     <span style="color: #ffa07a;">".org"</span>))))

(add-to-list 'lentic-init-functions
             'lentic-orgel-org-init)
</pre>
</div>
</div>
</li></ol>
</li></ol>
</div>


<div id="outline-container-sec-9-2-3" class="outline-4">
<h4 id="sec-9-2-3"><span class="section-number-4">9.2.3</span> org-&gt;clojure</h4>
<div class="outline-text-4" id="text-9-2-3">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-org-clojure-oset</span> (conf)
  (lentic-m-oset
   conf
   <span style="color: #b0c4de;">:this-buffer</span> (current-buffer)
   <span style="color: #b0c4de;">:comment</span> <span style="color: #ffa07a;">";; "</span>
   <span style="color: #b0c4de;">:comment-stop</span> <span style="color: #ffa07a;">"#\\\+BEGIN_SRC clojure.*"</span>
   <span style="color: #b0c4de;">:comment-start</span> <span style="color: #ffa07a;">"#\\\+END_SRC"</span>))

<span style="color: #ff7f24;">;;;</span><span style="color: #ff7f24;">###</span><span style="color: #ffc0cb; font-weight: bold;">autoload</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-org-clojure-init</span> ()
  (lentic-org-clojure-oset
   (lentic-unmatched-uncommented-chunk-configuration
    <span style="color: #ffa07a;">"lb-org-to-clojure"</span>
    <span style="color: #b0c4de;">:lentic-file</span>
    (concat
     (file-name-sans-extension
      (buffer-file-name))
     <span style="color: #ffa07a;">".clj"</span>))))

(add-to-list 'lentic-init-functions
             'lentic-org-clojure-init)

<span style="color: #ff7f24;">;;;</span><span style="color: #ff7f24;">###</span><span style="color: #ffc0cb; font-weight: bold;">autoload</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-clojure-org-init</span> ()
  (lentic-org-clojure-oset
   (lentic-unmatched-commented-chunk-configuration
    <span style="color: #ffa07a;">"lb-clojure-to-org"</span>
    <span style="color: #b0c4de;">:lentic-file</span>
    (concat
     (file-name-sans-extension
      (buffer-file-name))
     <span style="color: #ffa07a;">".org"</span>))))

(add-to-list 'lentic-init-functions
             'lentic-clojure-org-init)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-9-2-4" class="outline-4">
<h4 id="sec-9-2-4"><span class="section-number-4">9.2.4</span> org-&gt;python</h4>
<div class="outline-text-4" id="text-9-2-4">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-org-python-oset</span> (conf)
  (lentic-m-oset
   conf
   <span style="color: #b0c4de;">:this-buffer</span> (current-buffer)
   <span style="color: #b0c4de;">:comment</span> <span style="color: #ffa07a;">"## "</span>
   <span style="color: #b0c4de;">:comment-stop</span> <span style="color: #ffa07a;">"#\\\+BEGIN_SRC python.*"</span>
   <span style="color: #b0c4de;">:comment-start</span> <span style="color: #ffa07a;">"#\\\+END_SRC"</span>))

<span style="color: #ff7f24;">;;;</span><span style="color: #ff7f24;">###</span><span style="color: #ffc0cb; font-weight: bold;">autoload</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-org-python-init</span> ()
  (lentic-org-python-oset
   (lentic-unmatched-uncommented-chunk-configuration
    <span style="color: #ffa07a;">"lb-org-to-python"</span>
    <span style="color: #b0c4de;">:lentic-file</span>
    (concat
     (file-name-sans-extension
      (buffer-file-name))
     <span style="color: #ffa07a;">".py"</span>))))

(add-to-list 'lentic-init-functions
             'lentic-org-python-init)

<span style="color: #ff7f24;">;;;</span><span style="color: #ff7f24;">###</span><span style="color: #ffc0cb; font-weight: bold;">autoload</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-python-org-init</span> ()
  (lentic-org-python-oset
   (lentic-unmatched-commented-chunk-configuration
    <span style="color: #ffa07a;">"lb-python-to-org"</span>
    <span style="color: #b0c4de;">:lentic-file</span>
    (concat
     (file-name-sans-extension
      (buffer-file-name))
     <span style="color: #ffa07a;">".org"</span>))))

(add-to-list 'lentic-init-functions
             'lentic-python-org-init)
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-9-3" class="outline-3">
<h3 id="sec-9-3"><span class="section-number-3">9.3</span> Footer</h3>
<div class="outline-text-3" id="text-9-3">
<p>
Declare the end of the file, and add file-local support for orgel-&gt;org
transformation. Do not use lentics on this file while changing the
lisp in the file without backing up first!
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">provide</span> '<span style="color: #7fffd4;">lentic-org</span>)
<span style="color: #ff7f24;">;;; </span><span style="color: #ff7f24;">lentic-org.el ends here</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-10" class="outline-2">
<h2 id="sec-10"><span class="section-number-2">10</span> Lentic Dev</h2>
<div class="outline-text-2" id="text-10">
<p>
Tools for developers of new configurations.
</p>
</div>

<div id="outline-container-sec-10-1" class="outline-3">
<h3 id="sec-10-1"><span class="section-number-3">10.1</span> Commentary</h3>
<div class="outline-text-3" id="text-10-1">
<p>
Developing support for new forms of lentic buffers is not trivial. This
file provides some support functions for doing so.
</p>
</div>
</div>

<div id="outline-container-sec-10-2" class="outline-3">
<h3 id="sec-10-2"><span class="section-number-3">10.2</span> Code</h3>
<div class="outline-text-3" id="text-10-2">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">require</span> '<span style="color: #7fffd4;">lentic</span>)
</pre>
</div>
</div>

<div id="outline-container-sec-10-2-1" class="outline-4">
<h4 id="sec-10-2-1"><span class="section-number-4">10.2.1</span> Manual Updates</h4>
<div class="outline-text-4" id="text-10-2-1">
<p>
Usually, lentic uses Emacs hooks to percolate changes in one buffer to
another. Unfortunately, all the hooks that do this not only silently discard
errors, but they delete the offending function from the hook. So, post-mortem
debugging is hard. Step-through is also hard since it happens in the command
loop.
</p>

<p>
Lentic has a function for disabling its functionality (due to breakage
rather than just normal switching it off), called `linked-buffer-emergency'
(and the inverse `linked-buffer-unemergency'). In this emergency state, we
can still run the hooks manually, which is by far the best way to debug them.
</p>

<p>
For the `lentic-test-after-change-function' to work `lentic-emergency-debug'
must be set. It is also critical that only a single change has happened before
this function is called &#x2013; otherwise the result of the previous change are
deleted, and the lentic buffers will update in an inconsistent and haphazard
way.
</p>


<div class="org-src-container">

<pre class="src src-emacs-lisp"><span style="color: #ff7f24;">;;;</span><span style="color: #ff7f24;">###</span><span style="color: #ffc0cb; font-weight: bold;">autoload</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-dev-after-change-function</span> ()
  <span style="color: #ffa07a;">"Run the change functions out of the command loop.</span>
<span style="color: #ffa07a;">Using this function is the easiest way to test an new</span>
<span style="color: #ffa07a;">`</span><span style="color: #7fffd4;">lentic-clone</span><span style="color: #ffa07a;">' method, as doing so in the command loop is</span>
<span style="color: #ffa07a;">painful for debugging. Set variable `</span><span style="color: #7fffd4;">lentic-emergency</span><span style="color: #ffa07a;">' to</span>
<span style="color: #ffa07a;">true to disable command loop functionality."</span>
  (<span style="color: #00ffff;">interactive</span>)
  (message <span style="color: #ffa07a;">"Running after change with args: %s"</span>
           lentic-emergency-last-change)
  (apply 'lentic-after-change-function-1
         lentic-emergency-last-change))

<span style="color: #ff7f24;">;;;</span><span style="color: #ff7f24;">###</span><span style="color: #ffc0cb; font-weight: bold;">autoload</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-dev-post-command-hook</span> ()
  <span style="color: #ffa07a;">"Run the post-command functions out of the command loop.</span>
<span style="color: #ffa07a;">Using this function is the easiest way to test an new</span>
<span style="color: #ffa07a;">`</span><span style="color: #7fffd4;">lentic-convert</span><span style="color: #ffa07a;">' method, as doing so in the command loop is</span>
<span style="color: #ffa07a;">painful for debugging. Set variable `</span><span style="color: #7fffd4;">lentic-emergency</span><span style="color: #ffa07a;">' to</span>
<span style="color: #ffa07a;">true to disable command loop functionality."</span>
  (<span style="color: #00ffff;">interactive</span>)
  (lentic-post-command-hook-1 (current-buffer) '()))

<span style="color: #ff7f24;">;;;</span><span style="color: #ff7f24;">###</span><span style="color: #ffc0cb; font-weight: bold;">autoload</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-dev-after-save-hook</span> ()
  (<span style="color: #00ffff;">interactive</span>)
  (<span style="color: #00ffff;">let</span> ((lentic-emergency nil))
    (lentic-mode-after-save-hook)))

<span style="color: #ff7f24;">;;;</span><span style="color: #ff7f24;">###</span><span style="color: #ffc0cb; font-weight: bold;">autoload</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-dev-mode-buffer-list-update-hook</span> ()
  (<span style="color: #00ffff;">interactive</span>)
  (<span style="color: #00ffff;">let</span> ((lentic-emergency nil))
    (lentic-mode-buffer-list-update-hook)))

<span style="color: #ff7f24;">;;;</span><span style="color: #ff7f24;">###</span><span style="color: #ffc0cb; font-weight: bold;">autoload</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-dev-kill-buffer-hook</span> ()
  (<span style="color: #00ffff;">interactive</span>)
  (<span style="color: #00ffff;">let</span> ((lentic-emergency nil))
    (lentic-kill-buffer-hook)))

<span style="color: #ff7f24;">;;;</span><span style="color: #ff7f24;">###</span><span style="color: #ffc0cb; font-weight: bold;">autoload</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-dev-kill-emacs-hook</span> ()
  (<span style="color: #00ffff;">interactive</span>)
  (<span style="color: #00ffff;">let</span> ((lentic-emergency nil))
    (lentic-kill-emacs-hook)))

<span style="color: #ff7f24;">;;;</span><span style="color: #ff7f24;">###</span><span style="color: #ffc0cb; font-weight: bold;">autoload</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-dev-reinit</span> ()
  <span style="color: #ffa07a;">"Recall the init function regardless of current status.</span>
<span style="color: #ffa07a;">This can help if you have change the config object and need</span>
<span style="color: #ffa07a;">to make sure there is a new one."</span>
  (<span style="color: #00ffff;">interactive</span>)
  (<span style="color: #00ffff;">setq</span> lentic-config nil)
  (lentic-ensure-init))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-10-2-2" class="outline-4">
<h4 id="sec-10-2-2"><span class="section-number-4">10.2.2</span> Font-Lock changes</h4>
<div class="outline-text-4" id="text-10-2-2">
<p>
These commands enable or disable fontification of changes that lentic has
percolated. This is very useful for incremental changes; it's the only
practical way of seeing what has been copied.
</p>

<p>
The exact behaviour of this depends on the mode of the buffer displaying the
lentic buffer. Sometimes, the natural buffer fontification functions just
change the font back to whatever the syntax suggests. In this case, try
switching off `font-lock-mode'.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">defvar</span> <span style="color: #eedd82;">lentic-dev-insert-face</span>
  <span style="color: #ffa07a;">"Start face to use for inserted text."</span>
  'font-lock-keyword-face)

<span style="color: #ff7f24;">;;;</span><span style="color: #ff7f24;">###</span><span style="color: #ffc0cb; font-weight: bold;">autoload</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-dev-random-face</span> ()
  <span style="color: #ffa07a;">"Change the insertion face to a random one."</span>
  (<span style="color: #00ffff;">interactive</span>)
  (<span style="color: #00ffff;">setq</span> lentic-dev-insert-face
        (nth (random (length (face-list)))
             (face-list)))
  (message <span style="color: #ffa07a;">"Insert face is now %s"</span>
           (propertize
            <span style="color: #ffa07a;">"this"</span>
            'face
            lentic-dev-insert-face)))

(<span style="color: #00ffff;">defadvice</span> <span style="color: #87cefa;">lentic-insertion-string-transform</span>
  (after face-transform
         (string)
         disable)
  (<span style="color: #00ffff;">setq</span> ad-return-value
        (propertize
         string
         'font-lock-face
         lentic-dev-insert-face
         'face
         lentic-dev-insert-face)))

(<span style="color: #00ffff;">defvar</span> <span style="color: #eedd82;">lentic-dev-enable-insertion-marking</span> nil)

<span style="color: #ff7f24;">;;;</span><span style="color: #ff7f24;">###</span><span style="color: #ffc0cb; font-weight: bold;">autoload</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-dev-enable-insertion-marking</span> ()
  <span style="color: #ffa07a;">"Enable font locking properties for inserted text."</span>
  (<span style="color: #00ffff;">interactive</span>)
  (<span style="color: #00ffff;">if</span> lentic-dev-enable-insertion-marking
      (<span style="color: #00ffff;">progn</span>
        (ad-deactivate 'lentic-insertion-string-transform)
        (<span style="color: #00ffff;">setq</span> lentic-enable-insertion-marking nil)
        (message <span style="color: #ffa07a;">"Insertion marking off"</span>))
    (ad-enable-advice 'lentic-insertion-string-transform
                      'after 'face-transform)
    (ad-activate 'lentic-insertion-string-transform)
    (<span style="color: #00ffff;">setq</span> lentic-enable-insertion-marking t)
    (message <span style="color: #ffa07a;">"Insertion marking on"</span>)))


(<span style="color: #00ffff;">defadvice</span> <span style="color: #87cefa;">lentic-after-change-transform</span>
    (after pulse-transform (buffer start stop length-before) disable)
  (<span style="color: #00ffff;">with-current-buffer</span>
      buffer
    (pulse-momentary-highlight-region
     (<span style="color: #00ffff;">or</span> start (point-min))
     (<span style="color: #00ffff;">or</span> stop (point-max)))))

(<span style="color: #00ffff;">defvar</span> <span style="color: #eedd82;">lentic-dev-enable-insertion-pulse</span> nil)

<span style="color: #ff7f24;">;;;</span><span style="color: #ff7f24;">###</span><span style="color: #ffc0cb; font-weight: bold;">autoload</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-dev-enable-insertion-pulse</span> ()
  (<span style="color: #00ffff;">interactive</span>)
  (<span style="color: #00ffff;">if</span> lentic-dev-enable-insertion-pulse
      (<span style="color: #00ffff;">progn</span>
        (ad-deactivate 'lentic-after-change-transform)
        (<span style="color: #00ffff;">setq</span> lentic-dev-enable-insertion-pulse nil)
        (message <span style="color: #ffa07a;">"insertion pulse off"</span>))
    (ad-enable-advice 'lentic-after-change-transform
                      'after 'pulse-transform)
    (ad-activate 'lentic-after-change-transform)
    (<span style="color: #00ffff;">setq</span> lentic-dev-enable-insertion-pulse t)
    (message <span style="color: #ffa07a;">"insertion pulse on"</span>)))


(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-dev-edebug-trace-mode</span> ()
  (<span style="color: #00ffff;">setq</span> edebug-initial-mode 'continue)
  (<span style="color: #00ffff;">setq</span> edebug-trace t))


(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-dev-highlight-markers</span> ()
  (<span style="color: #00ffff;">interactive</span>)
  (m-buffer-overlay-font-lock-face-match
   (lentic-blk-marker-boundaries
    (car lentic-config)
    (current-buffer))
   'highlight))

(<span style="color: #00ffff;">provide</span> '<span style="color: #7fffd4;">lentic-dev</span>)
<span style="color: #ff7f24;">;;; </span><span style="color: #ff7f24;">lentic-dev.el ends here</span>
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-11" class="outline-2">
<h2 id="sec-11"><span class="section-number-2">11</span> Lentic Doc</h2>
<div class="outline-text-2" id="text-11">
<p>
Lentic has a self-hosting documentation system which is defined here.
</p>
</div>

<div id="outline-container-sec-11-1" class="outline-3">
<h3 id="sec-11-1"><span class="section-number-3">11.1</span> Commentary</h3>
<div class="outline-text-3" id="text-11-1">
<p>
Lentic's self-hosting documentation system.
</p>
</div>
</div>

<div id="outline-container-sec-11-2" class="outline-3">
<h3 id="sec-11-2"><span class="section-number-3">11.2</span> Code</h3>
<div class="outline-text-3" id="text-11-2">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">require</span> '<span style="color: #7fffd4;">eww</span>)
(<span style="color: #00ffff;">require</span> '<span style="color: #7fffd4;">ox-html</span>)
(<span style="color: #00ffff;">require</span> '<span style="color: #7fffd4;">browse-url</span>)
(<span style="color: #00ffff;">require</span> '<span style="color: #7fffd4;">lentic</span>)
(<span style="color: #00ffff;">require</span> '<span style="color: #7fffd4;">lentic-org</span>)
(<span style="color: #00ffff;">require</span> '<span style="color: #7fffd4;">f</span>)
(<span style="color: #00ffff;">require</span> '<span style="color: #7fffd4;">s</span>)
</pre>
</div>
</div>

<div id="outline-container-sec-11-2-1" class="outline-4">
<h4 id="sec-11-2-1"><span class="section-number-4">11.2.1</span> Orgify Package</h4>
<div class="outline-text-4" id="text-11-2-1">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-doc-stringify</span> (str-or-sym)
  (<span style="color: #00ffff;">if</span> (symbolp str-or-sym)
      (symbol-name str-or-sym)
    str-or-sym))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-doc-all-files-of-package</span> (package)
  <span style="color: #ffa07a;">"Fetch all the files that are part of package.</span>
<span style="color: #ffa07a;">This function assumes that all the files are in one place and</span>
<span style="color: #ffa07a;">follow the standard naming convention of using the package name</span>
<span style="color: #ffa07a;">as a prefix. "</span>
  (<span style="color: #00ffff;">let*</span> ((main-file
          (locate-library package))
         (dir
          (f-parent main-file))
         (prefix
          (concat dir <span style="color: #ffa07a;">"/"</span> package))
         (others
          (f-glob
           (concat prefix <span style="color: #ffa07a;">"*.el"</span>)))
         (scripts
          (f-glob
           (concat prefix <span style="color: #ffa07a;">"*.els"</span>))))
    (<span style="color: #00ffff;">-remove</span>
     (<span style="color: #00ffff;">lambda</span> (file)
       (<span style="color: #00ffff;">or</span> (s-match <span style="color: #ffa07a;">".*-pkg.el"</span> file)
           (s-match <span style="color: #ffa07a;">".*-autoloads.el"</span> file)))
     (append others scripts))))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-doc-orgify-if-necessary</span> (file)
  (<span style="color: #00ffff;">let*</span> ((target
          (concat
           (file-name-sans-extension file)
           <span style="color: #ffa07a;">".org"</span>))
         (locked
          (<span style="color: #00ffff;">or</span> (file-locked-p file)
              (file-locked-p target)))
         (open
          (<span style="color: #00ffff;">or</span>
           (get-file-buffer file)
           (get-file-buffer target))))
    (<span style="color: #00ffff;">unless</span> (<span style="color: #00ffff;">or</span> locked open)
      (<span style="color: #00ffff;">when</span> (file-newer-than-file-p file target)
        (<span style="color: #00ffff;">let</span> ((lentic-kill-retain t))
          (lentic-batch-clone-and-save-with-config
           file 'lentic-orgel-org-init))))))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-doc-orgify-all-if-necessary</span> (files)
  (<span style="color: #00ffff;">-map</span> 'lentic-doc-orgify-if-necessary files))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-doc-orgify-package</span> (package)
  (lentic-doc-orgify-all-if-necessary
   (lentic-doc-all-files-of-package
    (lentic-doc-stringify package))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-11-2-2" class="outline-4">
<h4 id="sec-11-2-2"><span class="section-number-4">11.2.2</span> htmlify package</h4>
<div class="outline-text-4" id="text-11-2-2">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-doc-htmlify-package</span> (package)
  (<span style="color: #00ffff;">let</span> ((package
         (lentic-doc-stringify package)))
    (lentic-doc-orgify-package package)
    (<span style="color: #00ffff;">with-current-buffer</span>
        (find-file-noselect
         (lentic-doc-package-start-source package))
      (<span style="color: #00ffff;">let</span> ((org-html-htmlize-output-type 'css))
        (org-html-export-to-html)))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-emacs-lisp"><span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">remove when it gets into f.el</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-f-swap-ext</span> (path ext)
  <span style="color: #ffa07a;">"Return PATH but with EXT as the new extension.</span>
<span style="color: #ffa07a;">EXT must not be nil or empty."</span>
  (<span style="color: #00ffff;">if</span> (s-blank? ext)
      (<span style="color: #ffc0cb; font-weight: bold;">error</span> <span style="color: #ffa07a;">"extension cannot be empty or nil."</span>)
    (concat (f-no-ext path) <span style="color: #ffa07a;">"."</span> ext)))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-doc-package-start-source</span> (package)
  (<span style="color: #00ffff;">let</span> ((doc-var
         (intern
          (concat package <span style="color: #ffa07a;">"-doc"</span>))))
    (<span style="color: #00ffff;">if</span> (boundp doc-var)
        <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">if it is set to a boolean return the implicit start</span>
        (<span style="color: #00ffff;">if</span> (booleanp
             (symbol-value doc-var))
            (lentic-doc-package-implicit-start-source package)
          (f-join
           (f-parent (locate-library package))
           (symbol-value doc-var)))
      <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">get the default</span>
      (<span style="color: #00ffff;">let*</span>
          ((main-file
            (locate-library package))
           (doc-file
            (<span style="color: #00ffff;">when</span> main-file
              (f-join
               (f-parent main-file)
               (concat
                (f-no-ext main-file)
                <span style="color: #ffa07a;">"-doc.org"</span>)))))
        (<span style="color: #00ffff;">when</span>
            (<span style="color: #00ffff;">and</span> doc-file
                 (f-exists? doc-file))
            doc-file)))))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-doc-package-implicit-start-source</span> (package)
  (<span style="color: #00ffff;">-if-let</span> (lib (locate-library package))
      (<span style="color: #00ffff;">let</span> ((start
              (lentic-f-swap-ext
               lib
               <span style="color: #ffa07a;">"org"</span>)))
        (<span style="color: #00ffff;">if</span> (f-exists? start)
            start))))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-doc-package-doc-file</span> (package)
  (lentic-f-swap-ext
   (lentic-doc-package-start-source package)
   <span style="color: #ffa07a;">"html"</span>))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-doc-ensure-doc</span> (package)
  (<span style="color: #00ffff;">unless</span> (f-exists?
           (lentic-doc-package-doc-file package))
    (lentic-doc-htmlify-package package)))

(<span style="color: #00ffff;">defvar</span> <span style="color: #eedd82;">lentic-doc-lentic-features</span> nil)
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-doc-all-lentic-features-capture</span>()
  (<span style="color: #00ffff;">setq</span> lentic-doc-lentic-features
        (cons
         (length features)
         (<span style="color: #00ffff;">-map</span>
          (<span style="color: #00ffff;">lambda</span> (feat)
            (symbol-name feat))
          (<span style="color: #00ffff;">-filter</span>
           (<span style="color: #00ffff;">lambda</span> (feat)
             (lentic-doc-package-start-source
              (symbol-name feat)))
           features)))))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-doc-all-lentic-features</span> ()
  (<span style="color: #00ffff;">unless</span>
      (<span style="color: #00ffff;">and</span> lentic-doc-lentic-features
           (equal
            (car lentic-doc-lentic-features)
            (length features)))
    (lentic-doc-all-lentic-features-capture))
  (cdr lentic-doc-lentic-features))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-doc-external-view</span> (package)
  (<span style="color: #00ffff;">interactive</span>
   (list
    (completing-read
     <span style="color: #ffa07a;">"Package Name: "</span>
     (lentic-doc-all-lentic-features))))
  (<span style="color: #00ffff;">let</span> ((package (lentic-doc-stringify package)))
    (lentic-doc-ensure-doc package)
    (browse-url-default-browser
     (lentic-doc-package-doc-file package))))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">lentic-doc-eww-view</span> (package)
  (<span style="color: #00ffff;">interactive</span>
   (list
    (completing-read
     <span style="color: #ffa07a;">"Package Name: "</span>
     (lentic-doc-all-lentic-features))))
  (<span style="color: #00ffff;">let</span> ((package (lentic-doc-stringify package)))
    (lentic-doc-ensure-doc package)
    (eww-open-file
     (lentic-doc-package-doc-file package))))


(<span style="color: #00ffff;">provide</span> '<span style="color: #7fffd4;">lentic-doc</span>)
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Phillip Lord</p>
<p class="date">Created: 2016-07-25 Mon 08:56</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 25.0.95.1 (<a href="http://orgmode.org">Org</a> mode 8.2.10)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
